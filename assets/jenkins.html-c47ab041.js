import{_ as l,M as i,p,q as c,R as n,t as s,N as e,V as r,a1 as t}from"./framework-bf3e1922.js";const u="/AS-CloudDocs/assets/branch-discovery-d986e445.png",d={},h=n("h1",{id:"jenkins-pipelines",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#jenkins-pipelines","aria-hidden":"true"},"#"),s(" Jenkins Pipelines")],-1),v=n("p",null,"A Jenkins pipeline is a script that takes your application from version control to deployment. The pipeline file is kept in your application's Github repository, follows normal pull request review procedure, and is promoted from dev/qa/prod using the same process as your code.",-1),m=n("p",null,[s('Jenkins pipelines have several flavours. Unless you have reason to deviate, our standards are multi-branch declarative pipelines. Multi-branch pipelines will detect all branches & pull requests and run them inside the "parent" job: perfect for running tests or deploying dev/qa environments. There may be cases where this is '),n("em",null,"not"),s(" appropriate, such as a pipeline that runs on a schedule and kicks off a scheduled deployment.")],-1),k={href:"https://jenkins.io/doc/book/pipeline/syntax/",target:"_blank",rel:"noopener noreferrer"},b=n("div",{class:"hint-container warning"},[n("p",{class:"hint-container-title"},"Legacy Jenkins Jobs"),n("p",null,"If you have used Jenkins in the past, you may be familiar with configuring jobs."),n("p",null,"These legacy-style jobs should be replaced by pipelines files kept in version control. No new jobs should be configured this way.")],-1),g=n("p",null,[s("We typically keep pipeline files in a "),n("code",null,".jenkins/"),s(" folder. Even if you only have a single Jenkinsfile, it is advisable to put it in the folder; changing it later is a nuisance.")],-1),f=n("h2",{id:"accessing-github-repositories",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#accessing-github-repositories","aria-hidden":"true"},"#"),s(" Accessing GitHub Repositories")],-1),y=n("p",null,"Jenkins must authenticate to GitHub.com as a user in order to clone code. This user must be a collaborator on the repository that you want Jenkins to work with.",-1),_=n("a",{href:"#credentials"},[n("code",null,"GitHub-awsCloudOpsCJT")],-1),w={href:"https://github.com/awsCloudOpsCJT",target:"_blank",rel:"noopener noreferrer"},x={href:"https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-status-checks",target:"_blank",rel:"noopener noreferrer"},C=n("p",null,"If you need awsCloudOpsCJT or a team-specific user added as a collaborator, contact the EACD-CloudOps group -- self-service tooling for this is not available yet, sorry!",-1),J=n("h2",{id:"configuration",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#configuration","aria-hidden":"true"},"#"),s(" Configuration")],-1),S=n("p",null,"As much configuration as possible should be included in the Jenkinsfile.",-1),T={href:"https://jenkins.io/doc/book/pipeline/syntax/#options",target:"_blank",rel:"noopener noreferrer"},O=n("ul",null,[n("li",null,[n("code",null,"disableConcurrentBuilds()"),s(" is a commonly-used option; you wouldn't want to "),n("code",null,"terraform apply"),s(" off the same tfstate file at the same time.")])],-1),q={href:"https://jenkins.io/doc/book/pipeline/syntax/#triggers",target:"_blank",rel:"noopener noreferrer"},E=n("ul",null,[n("li",null,[n("code",null,"pollSCM('H/10 * * * *')"),s(" is popular; Jenkins is firewalled off so Github cannot notify it when code is pushed")])],-1),H={href:"https://jenkins.io/doc/book/pipeline/syntax/#parameters",target:"_blank",rel:"noopener noreferrer"},j=t('<p>The most notable item that you cannot include is branch discovery for a multi-branch pipeline. This must be configured in the Jenkins UI:</p><p><img src="'+u+`" alt="Branch discovery settings"></p><h2 id="credentials" tabindex="-1"><a class="header-anchor" href="#credentials" aria-hidden="true">#</a> Credentials</h2><p>Jenkins has a credential store that your pipelines may access. These credentials are items necessary for deployments.</p><p>Out of the box, three credentials will exist:</p><ul><li><code>terraform</code>, an AWS credential for creating resources via Terraform</li><li><code>teams-build-webhook</code>, the URL for posting status messages to Teams</li><li><code>GitHub-awsCloudOpsCJT</code>, a Github user in our organization</li></ul><p>You can ask the EACD-CloudOps group for help if you need to add pipeline-specific secrets to your Jenkins servers.</p><h2 id="agents" tabindex="-1"><a class="header-anchor" href="#agents" aria-hidden="true">#</a> Agents</h2><p>By default, a pipeline will run on the main Jenkins server. It will have the tools available on a fairly standard CentOS Linux installation, plus the <code>terraform</code> binary and docker CLI tools.</p><p>If you need more specialized tools -- specific versions of NodeJS for example -- you can use a Docker agent instead:</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code>agent <span class="token punctuation">{</span>
    docker <span class="token punctuation">{</span>
        image <span class="token string">&#39;node:10&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can choose an agent for your pipeline file or for specific stages. Jenkins will download the Docker image from Docker Hub and execute your pipeline inside of that container. If no community-maintained image is available for your needs, you can write your own Dockerfile and use it as the agent as well.</p><h3 id="heavy-tasks" tabindex="-1"><a class="header-anchor" href="#heavy-tasks" aria-hidden="true">#</a> Heavy Tasks</h3><p>For small units of work, running things on the Jenkins server is fine. However, when running more computationally-expensive pipelines, you are liable to consume all available CPU/memory. Jenkins may become unresponsive, unable to run additional tasks, or crash.</p>`,14),A=t(`<h2 id="example-pipeline" tabindex="-1"><a class="header-anchor" href="#example-pipeline" aria-hidden="true">#</a> Example Pipeline</h2><p>This is an example pipeline for testing a PHP 7.4 application. The entire pipeline runs in a community-maintained Docker image pulled in from Docker Hub. Jenkins will scan GitHub for any new commits every 10 minutes, and kick the pipeline off for any new/changed branches. When it runs, it will ping a Teams channel. If the build succeeds or fails, a follow-up will be posted to Teams.</p><p>The very first line (<code>#!groovy</code>) is a trick we use to get correct syntax highlighting in VSCode. It has no other effect.</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token shebang comment">#!groovy</span>
pipeline <span class="token punctuation">{</span>
    agent <span class="token punctuation">{</span>
        docker <span class="token punctuation">{</span>
            image <span class="token string">&#39;edbizarro/gitlab-ci-pipeline-php:7.4&#39;</span>
            args <span class="token string">&#39;-u root:root&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    environment <span class="token punctuation">{</span>
        TEAMS_WEBHOOK_URL <span class="token operator">=</span> <span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">&#39;teams-build-webhook&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    triggers <span class="token punctuation">{</span>
        <span class="token function">pollSCM</span><span class="token punctuation">(</span><span class="token string">&#39;H/10 * * * *&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    options <span class="token punctuation">{</span>
        <span class="token function">disableConcurrentBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    stages <span class="token punctuation">{</span>
        stage <span class="token punctuation">(</span><span class="token string">&#39;Send Notifications&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                office365ConnectorSend status<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;Started&quot;</span></span><span class="token punctuation">,</span> webhookUrl<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>TEAMS_WEBHOOK_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        stages <span class="token punctuation">{</span>
            stage <span class="token punctuation">(</span><span class="token string">&#39;Test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                steps <span class="token punctuation">{</span>
                    sh <span class="token string">&#39;composer install&#39;</span>
                    sh <span class="token string">&#39;./vendor/bin/phpunit&#39;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    post <span class="token punctuation">{</span>
        success <span class="token punctuation">{</span>
            office365ConnectorSend status<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;Success!&quot;</span></span><span class="token punctuation">,</span> webhookUrl<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>TEAMS_WEBHOOK_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">}</span>

        failure <span class="token punctuation">{</span>
            office365ConnectorSend status<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;Failed&quot;</span></span><span class="token punctuation">,</span> webhookUrl<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token expression">env<span class="token punctuation">.</span>TEAMS_WEBHOOK_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="scheduling-deployments" tabindex="-1"><a class="header-anchor" href="#scheduling-deployments" aria-hidden="true">#</a> Scheduling Deployments</h2><p>You must regularly re-deploy your application. Our minimum is once per week, but more frequent deployments are encouraged.</p><p>Re-deploying on a schedule, even when no changes are pending deployment, ensures that your pipeline &amp; deployment process is valid. Some applications may go into a period of development inactivity; it&#39;s good to know that you can apply a critical security patch without worrying if your pipeline still works after not being used for nine months.</p><p>You can create a pair of regular (not multi-branch) pipelines that trigger your main Jenkinsfile&#39;s develop/qa &amp; production branch builds.</p><p>Here is an example Jenkinsfile that will schedule itself to run every day at noon. When it runs, it will trigger a build for the <code>develop</code> branch in the <code>OnBase SSO Shim</code> multi-branch pipeline. This way, it&#39;s using the exact same deployment process as when changes are pushed to <code>develop</code>. Once that run is done, it will do the same for the <code>qa</code> branch:</p><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token shebang comment">#!groovy</span>
pipeline <span class="token punctuation">{</span>
    agent any

    triggers <span class="token punctuation">{</span>
        <span class="token function">cron</span><span class="token punctuation">(</span><span class="token string">&#39;H 12 * * *&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    stages <span class="token punctuation">{</span>
        stage <span class="token punctuation">(</span><span class="token string">&#39;Deploy Sub-production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                <span class="token function">build</span><span class="token punctuation">(</span>job<span class="token punctuation">:</span> <span class="token string">&#39;OnBase SSO Shim/develop&#39;</span><span class="token punctuation">)</span>
                <span class="token function">build</span><span class="token punctuation">(</span>job<span class="token punctuation">:</span> <span class="token string">&#39;OnBase SSO Shim/qa&#39;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10);function B(D,R){const a=i("ExternalLinkIcon"),o=i("RouterLink");return p(),c("div",null,[h,v,m,n("p",null,[s("Documentation on the declarative Jenkinsfile syntax can be found "),n("a",k,[s("on the Jenkins website"),e(a)]),s(".")]),b,g,f,y,n("p",null,[s("All Jenkins servers have the "),_,s(" credential for the "),n("a",w,[s("awsCloudOpsCJT user"),e(a)]),s(" that may be used. You may create a user specifically for your team if you want to more tightly control access to your repositories. Creating a team-specific user is recommended if you will be granting it write permission so Jenkins can update "),n("a",x,[s("commit statuses"),e(a)]),s(".")]),C,J,S,n("ul",null,[n("li",null,[s("Review the "),n("a",T,[s("options"),e(a)]),s(" section "),O]),n("li",null,[s("Review the "),n("a",q,[s("triggers"),e(a)]),s(" section "),E]),n("li",null,[s("Review the "),n("a",H,[s("parameters"),e(a)]),s(" section, if you need inputs")])]),j,n("p",null,[s("Instructions on offloading to dedicated worker hosts can be found in the "),e(o,{to:"/ci-cd/jenkins-ecs-agent.html"},{default:r(()=>[s("Jenkins ECS Agent")]),_:1}),s(" article. The EACD-CloudOps group may request you convert some pipeline(s) to using an ECS agent as problems are discovered.")]),A])}const L=l(d,[["render",B],["__file","jenkins.html.vue"]]);export{L as default};
