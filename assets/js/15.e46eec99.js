(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{372:function(e,t,n){"use strict";n.r(t);var s=n(41),a=Object(s.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"jenkins-ecs-agent"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-ecs-agent"}},[e._v("#")]),e._v(" Jenkins ECS Agent")]),e._v(" "),n("p",[e._v("With the "),n("a",{attrs:{href:"https://github.com/jenkinsci/amazon-ecs-plugin",target:"_blank",rel:"noopener noreferrer"}},[e._v("Elastic Container Plugin agent for Jenkins"),n("OutboundLink")],1),e._v(", the work involved in running a Jenkins pipeline (partially or entirely) can be offloaded from the primary Jenkins server to remote compute spun up on-demand. When the pipeline is done running, the compute will be torn down.")]),e._v(" "),n("p",[e._v("For our implementation, we have chosen ECS Fargate. We do not maintain the EC2s or much infrastructure -- we just ask AWS to run a Docker image in our VPC with a specific amount of CPU/memory.")]),e._v(" "),n("ul",[n("li",[n("p",[n("strong",[e._v("Pro")])]),e._v(" "),n("ul",[n("li",[e._v("Only billed for the compute we need; no EC2s sitting around idling")]),e._v(" "),n("li",[e._v("Rogue jobs filling up disk / using all available CPU/memory will not impact other jobs or crash Jenkins")]),e._v(" "),n("li",[e._v("Can get more CPU/memory than the priamry Jenkins server has available")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("Con")])]),e._v(" "),n("ul",[n("li",[e._v("Pipeline takes longer to start; has to wait for compute to spin up")]),e._v(" "),n("li",[e._v("Requires JNLP-enabled Docker images; mostly have to write & maintain ourselves")]),e._v(" "),n("li",[e._v("ECS Agent plugin "),n("a",{attrs:{href:"https://github.com/jenkinsci/amazon-ecs-plugin/issues/138",target:"_blank",rel:"noopener noreferrer"}},[e._v("does not currently support Fargate Spot market"),n("OutboundLink")],1)])])])]),e._v(" "),n("h2",{attrs:{id:"using-ecs-agent"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#using-ecs-agent"}},[e._v("#")]),e._v(" Using ECS Agent")]),e._v(" "),n("p",[e._v("If you want to use a remote ECS agent, you should adjust the "),n("code",[e._v("agent")]),e._v(" block in your pipeline.")]),e._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[e._v("Work in Progress")]),e._v(" "),n("p",[e._v("This implementation is a work in progress. It is available in the ADO Jenkins environments.")]),e._v(" "),n("p",[e._v("Please contact EACD for a current list of applicable "),n("code",[e._v("inheritFrom")]),e._v(" containers. We are working to get the Docker image used under dev control.")])]),e._v(" "),n("div",{staticClass:"language-groovy extra-class"},[n("pre",{pre:!0,attrs:{class:"language-groovy"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang comment"}},[e._v("#!groovy")]),e._v("\npipeline "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    agent "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        ecs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            inheritFrom "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'jenkins-workers-php'")]),e._v("\n            cpu "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("2048")]),e._v("\n            memoryReservation "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("4096")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n    stages "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        stage "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Do stuff'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            steps "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n                sh "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'yarn install'")]),e._v("\n                sh "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'...'")]),e._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("You may override any of the ECS plugin's settings. For a list of available settings, see "),n("a",{attrs:{href:"https://github.com/jenkinsci/amazon-ecs-plugin/blob/master/src/main/java/com/cloudbees/jenkins/plugins/amazonecs/pipeline/ECSDeclarativeAgent.java#L28",target:"_blank",rel:"noopener noreferrer"}},[e._v("the properties for ECSDeclarativeAgent"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("p",[e._v("You "),n("strong",[e._v("cannot")]),e._v(" pick totally-arbitrary values for CPU/memory. ECS Fargate has an upper bound on how much memory is available based on the CPU shares requested. See Fargate documentation for "),n("a",{attrs:{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html#fargate-tasks-size",target:"_blank",rel:"noopener noreferrer"}},[e._v("a list of valid CPU/memory size combinations"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("Accessing On-Prem Resources")]),e._v(" "),n("p",[e._v("The remote ECS agents will run in the same subnet that the primary Jenkins server lives in.")]),e._v(" "),n("p",[e._v("If you need to access secure on-campus resources, submit your firewall requests using the subnet instead of the server's individual IP.")])]),e._v(" "),n("p",[e._v("As with any other Jenkins pipeline, you may choose a different agent in an individual stage block.")]),e._v(" "),n("h3",{attrs:{id:"troubleshooting"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),n("p",[e._v("If you are having problems using ECS remote workers, first check the log for the run in Jenkins. It will indicate if any pipeline errors have occurred.")]),e._v(" "),n("p",[e._v("If that log does not give you an indication of the issue, log in to your AWS account and check the "),n("code",[e._v("jenkins-workers")]),e._v(" ECS cluster. You can see if your task is pending or active, which indicate it's still running. You can search for stopped tasks as well. Their logs may include useful error messages.")]),e._v(" "),n("p",[e._v("If you do not see an ECS task being queued at all when you run the pipeline, it is possible the API call to create the ECS task is failing. Double-check your "),n("code",[e._v("cpu")]),e._v("/"),n("code",[e._v("memoryReservation")]),e._v(" combination is valid. If it is, contact the EACD or PIPS-CloudOps teams and ask them to review the Jenkins server logs -- AWS API errors are only made available in this logfile.")]),e._v(" "),n("h2",{attrs:{id:"adding-jenkins-jnlp-agent-to-docker-image"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#adding-jenkins-jnlp-agent-to-docker-image"}},[e._v("#")]),e._v(" Adding Jenkins JNLP Agent to Docker image")]),e._v(" "),n("p",[e._v("To use a Docker image as an ECS remote worker, it will need the Jenkins JNLP agent installed and configured as the entrypoint.")]),e._v(" "),n("p",[e._v("Select a suitable base Docker image to extend that includes the language/tool versions you want. You can find an image on Dockerhub, or write your own.")]),e._v(" "),n("h3",{attrs:{id:"debian-images"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#debian-images"}},[e._v("#")]),e._v(" Debian Images")]),e._v(" "),n("p",[e._v("This is an example of setting up Java & the agent for a PHP environment maintained by the Gitlab community. Their docker image is a Debian-based system that uses "),n("code",[e._v("apt")]),e._v(".")]),e._v(" "),n("div",{staticClass:"language-docker extra-class"},[n("pre",{pre:!0,attrs:{class:"language-docker"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" edbizarro/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("pipeline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("7.2\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Install the Jenkins agent on a Debian-family image")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("USER")]),e._v(" root "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Extended image may leave us as an unpriviledged user")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# https://github.com/geerlingguy/ansible-role-java/issues/64")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("p /usr/share/man/man1\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" DEBIAN_FRONTEND=noninteractive apt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("get update "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# fetch package lists")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" DEBIAN_FRONTEND=noninteractive apt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("get install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("yqq apt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("utils default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("jre "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# install Java runtime")]),e._v("\n\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Copy agent JARs from official Jenkins worker images ")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("from=jenkins/slave"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("latest /usr/share/jenkins/agent.jar /usr/share/jenkins/agent.jar\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("from=jenkins/jnlp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("slave"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("latest /usr/local/bin/jenkins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("agent /usr/bin/jenkins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("agent\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" chmod +x /usr/bin/jenkins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("agent && ln "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("s /usr/bin/jenkins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("agent /usr/bin/jenkins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("slave\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create workspace for Jenkins to use.")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# The `php` user is something from the extended image -- an unprivledges user.")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" mkdir /home/jenkins\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" chown php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("php /home/jenkins\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WORKDIR")]),e._v(" /home/jenkins\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Launch w/ the Jenkins agent JAR")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENTRYPOINT")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"jenkins-agent"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])])]),n("h3",{attrs:{id:"alpine-linux"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#alpine-linux"}},[e._v("#")]),e._v(" Alpine Linux")]),e._v(" "),n("p",[e._v("Alpine Linux is a minamalist Linux distribution. It is popular in the Docker community, since the minimalism keeps image size down.")]),e._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[e._v("TODO")]),e._v(" "),n("p",[e._v("We don't have an alpine example yet.")])])])}),[],!1,null,null,null);t.default=a.exports}}]);