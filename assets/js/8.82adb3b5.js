(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{351:function(t,e,a){t.exports=a.p+"assets/img/sharing-resources.02db9414.png"},375:function(t,e,a){"use strict";a.r(e);var s=a(43),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"example-terraform-module"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#example-terraform-module"}},[t._v("#")]),t._v(" Example Terraform Module")]),t._v(" "),s("p",[t._v("To illustrate the resource and module sharing concepts, think about an application deployed on the Elastic Container Service (ECS). You need the following resources:")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("Per account")]),t._v(" "),s("ul",[s("li",[t._v("Load balancer listener for the application (nonprod's would cover dev/qa)")]),t._v(" "),s("li",[t._v("HTTPS certificate for the load balancer")])])]),t._v(" "),s("li",[s("p",[t._v("Per application environment")]),t._v(" "),s("ul",[s("li",[t._v("Load balancer target group")]),t._v(" "),s("li",[t._v("ECS & EC2 resources")]),t._v(" "),s("li",[t._v("CloudWatch alarms")])])])]),t._v(" "),s("p",[t._v("That is two modules you would require -- one for shared account resources, and one for the application's dev/QA/production/etc environments. Both of these modules will need information about the account's VPC, and what subnet IDs have been allocated for the application by the AS Cloud Services team.")]),t._v(" "),s("p",[t._v("The load balancer will require a certificate. There is a ready-made module for generating certificate requests under the "),s("code",[t._v("entapp.northwestern.edu")]),t._v(" domain available in Github, so that can be used.")]),t._v(" "),s("p",[t._v("The per-application environment module will need to know the ARN for the load balancer listenen, so it can tie the target groups to it.")]),t._v(" "),s("p",[s("img",{attrs:{src:a(351),alt:"Terraform module relationships"}})]),t._v(" "),s("p",[t._v("Generating the certificate with the module that the AS Cloud Services team has already provided is easy:")]),t._v(" "),s("div",{staticClass:"language-hcl extra-class"},[s("pre",{pre:!0,attrs:{class:"language-hcl"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The hostname(s) will be passed in, as you'd want different ones for sandbox/nonprod/prod.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This module will automatically decide if you need a SAN cert (supports multiple hostnames) or a regular")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cert (with one hostname).")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module"),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v(' "certificate" ')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The double slash IS significant <https://www.terraform.io/docs/modules/sources.html#modules-in-package-sub-directories>")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("source")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/NIT-Administrative-Systems/AS-Common-AWS-Modules//entapp_certificate?ref=tf-0.12"')]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("hostnames")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" var.hostnames\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("This will expose the certificate's ARN as an attribute, which will be used in the next example.")]),t._v(" "),s("p",[t._v("The per-account module can access the remote state of your account's shared resources by declaring a "),s("code",[t._v("terraform_remote_state")]),t._v(" resource and providing it with the location of that module's state file:")]),t._v(" "),s("div",{staticClass:"language-hcl extra-class"},[s("pre",{pre:!0,attrs:{class:"language-hcl"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# You would pass the correct S3 bucket and file for the account in.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Sandbox / nonprod / prod would all be slightly different bucket")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# names and keys.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("data "),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"terraform_remote_state"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"account_wide_alb"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("backend")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3"')]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("config")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("bucket")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" var.alb_state_bucket\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("key")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" var.alb_state_file\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("region")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" var.alb_state_region\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# And then you can access any attributes that your shared account resource module")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# exposes with data.terraform_remote_state.{module_name}.{attribute}, as shown here")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# in the load_balancer_arn argument.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This also uses the certificate_arn attribute of the cert module we invoked in the")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# previous example.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_lb_listener"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lb_listener"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("load_balancer_arn")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" data.terraform_remote_state.account_wide_alb.outputs.lb_arn\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("port")]),t._v("              "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("protocol")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"HTTPS"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("ssl_policy")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ELBSecurityPolicy-2016-08"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("certificate_arn")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" module.certificate.certificate_arn\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_action")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fixed-response"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fixed_response")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("content_type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text/plain"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("message_body")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"No targets are responding to this request."')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("status_code")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"502"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Exports the listener's ARN as an attribute. ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# You will need to access this in the per-environment module.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("output"),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v(' "alb_listener_arn" ')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("value")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" aws_lb_listener.lb_listener.arn\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("Using another "),s("code",[t._v("terraform_remote_state")]),t._v(" resource, you can access the "),s("code",[t._v("alb_listener_arn")]),t._v(" attribute in your per-environment module.")])])}),[],!1,null,null,null);e.default=n.exports}}]);