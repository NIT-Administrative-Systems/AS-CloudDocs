(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{401:function(e,t,a){"use strict";a.r(t);var s=a(41),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"api-gateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-gateway"}},[e._v("#")]),e._v(" API Gateway")]),e._v(" "),a("p",[e._v("The AWS "),a("a",{attrs:{href:"https://docs.aws.amazon.com/apigateway/",target:"_blank",rel:"noopener noreferrer"}},[e._v("API Gateway"),a("OutboundLink")],1),e._v(" is Amazon's serverless platform for API development and delivery. It has many features found in "),a("a",{attrs:{href:"https://cloud.google.com/apigee/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Apigee"),a("OutboundLink")],1),e._v(", and can be used to similar purpose.")]),e._v(" "),a("p",[e._v("Amazon has a simplified and less-expensive version of API Gateway in beta, called "),a("a",{attrs:{href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP APIs"),a("OutboundLink")],1),e._v(". It drops support for most of the features we already rely on Apigee for.")]),e._v(" "),a("p",[e._v("Wherever possible, it is recommended to use the simplified HTTP API service instead of the classic v1 REST API service. The v1 service is still required for websocket support, but that is an uncommon use-case for Admin Systems.")]),e._v(" "),a("h2",{attrs:{id:"usage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#usage"}},[e._v("#")]),e._v(" Usage")]),e._v(" "),a("p",[e._v("Our typical use-case for API Gateway is as the load balancer for serverless APIs running on Lambda. We do not use most of the features it offers: documentation, API key management, rate limiting, and request/response re-writing are all handled in Apigee.")]),e._v(" "),a("p",[e._v("API Gateway imposes a 29-second max on requests. If you have some requests that may exceed this limitation, API Gateway is not appropriate for your use-case. There are "),a("a",{attrs:{href:"https://docs.amazonaws.cn/en_us/apigateway/latest/developerguide/limits.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("other limitations"),a("OutboundLink")],1),e._v(" on maximumn request/response size (and a number of other items) that should be reviewed before deciding to use API Gateway. "),a("RouterLink",{attrs:{to:"/infrastructure/alb.html"}},[e._v("ALBs")]),e._v(" can get around most of these limitations, but are an always-on service.")],1),e._v(" "),a("p",[e._v("In the past, we have created individual REST API resources in API Gateway. This has created complexity without giving us much value. Going forward, it is recommended that you create "),a("a",{attrs:{href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("simple API Gateway proxies"),a("OutboundLink")],1),e._v(" and handle routing/authorization in your application using "),a("a",{attrs:{href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("HTTP APIs"),a("OutboundLink")],1),e._v(" instead of the more-complex REST API product.")]),e._v(" "),a("p",[e._v("This is what you will need to set up an HTTP API for API Gateway that sends all HTTP requests to one Lambda:")]),e._v(" "),a("div",{staticClass:"language-hcl extra-class"},[a("pre",{pre:!0,attrs:{class:"language-hcl"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("resource "),a("span",{pre:!0,attrs:{class:"token type variable"}},[e._v('"aws_apigatewayv2_api"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"http_api"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("name")]),e._v("          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" local.application_name\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("protocol_type")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"HTTP"')]),e._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("target")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" aws_lambda_function.api.arn\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("route_key")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"$default"')]),e._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("tags")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" local.tags\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# API Gateway is allowed to invoke the Lambda")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("resource "),a("span",{pre:!0,attrs:{class:"token type variable"}},[e._v('"aws_lambda_permission"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"allow_http_api"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("action")]),e._v("        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"lambda:InvokeFunction"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("function_name")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" aws_lambda_function.api.arn\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("principal")]),e._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"apigateway.amazonaws.com"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("source_arn")]),e._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("aws_apigatewayv2_api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("http_api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("execution_arn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")])]),e._v('/*/$default"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[e._v("A more complete example for a NodeJS microservice is available in the "),a("a",{attrs:{href:"https://github.com/NIT-Administrative-Systems/AS-serverless-api-IaC",target:"_blank",rel:"noopener noreferrer"}},[e._v("AS-serverless-api-IaC"),a("OutboundLink")],1),e._v(" repository.")]),e._v(" "),a("h3",{attrs:{id:"apigee"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apigee"}},[e._v("#")]),e._v(" Apigee")]),e._v(" "),a("p",[e._v("APIs should be registered in our API management platform, Apigee.")]),e._v(" "),a("p",[e._v("Most of our APIs have been machine-to-machine integrations. We set up a single API key per environment in API Gateway. This allows Apigee to authenticate to the API. Further restriction on a per-application basis is handled in Apigee. The API Service Registry "),a("a",{attrs:{href:"https://apiserviceregistry.northwestern.edu/documentation/producer/prod-awssetup.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("has instructions on setting this up"),a("OutboundLink")],1),e._v(" on the Apigee side.")]),e._v(" "),a("p",[e._v("Apigee's "),a("code",[e._v("{env}.api.northwestern.edu")]),e._v(" hostname allows developers to skip the time-consuming process of setting up a custom domain & issuing a certificate for API Gateway. Since Apigee can provide a "),a("code",[e._v("*.northwestern.edu")]),e._v(" hostname, authenticating individual users with SSO from an SPA against an Apigee endpoint is possible.")]),e._v(" "),a("p",[e._v("Services being available to other developers for "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Mashup_(web_application_hybrid)",target:"_blank",rel:"noopener noreferrer"}},[e._v("mashup-"),a("OutboundLink")],1),e._v(" or "),a("a",{attrs:{href:"https://www.gartner.com/document/3980382",target:"_blank",rel:"noopener noreferrer"}},[e._v("MASA-"),a("OutboundLink")],1),e._v("style apps is highly valued by AS leadership, so making API endpoints available from a "),a("code",[e._v("*.northwestern.edu")]),e._v(" hostname is key.")]),e._v(" "),a("h2",{attrs:{id:"deployments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployments"}},[e._v("#")]),e._v(" Deployments")]),e._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[e._v("API Gateway v1 (REST API) Advice")]),e._v(" "),a("p",[e._v("This advice is only applicable to v1 REST APIs for API Gateway product. It is not relevant to HTTP APIs.")]),e._v(" "),a("p",[e._v("This section is maintained because we have legacy API Gateway deployments that pre-date the HTTP API product.")])]),e._v(" "),a("p",[e._v("The API Gateway configuration must be deployed before it goes into effect. You need an "),a("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/api_gateway_deployment.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("API Gateway Deployment resource"),a("OutboundLink")],1),e._v(" in Terraform to trigger the deployment. However, Terraform only deploys changed resources -- it needs to see a change with the deployment in order to trigger and re-deploy your API Gateway settings.")]),e._v(" "),a("p",[e._v("This can be achived by adding a variable with the current time. Terraform will always re-deploy the API when "),a("code",[e._v("terraform apply")]),e._v(" is run:")]),e._v(" "),a("div",{staticClass:"language-hcl extra-class"},[a("pre",{pre:!0,attrs:{class:"language-hcl"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("resource "),a("span",{pre:!0,attrs:{class:"token type variable"}},[e._v('"aws_api_gateway_deployment"')])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"deployment"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Other parameters . . .")]),e._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("variables")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Ensures TF re-deploys w/ the new timestamp every time it runs")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("deployed_at")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" timestamp()\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("lifecycle")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v("create_before_destroy")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);