(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{378:function(t,e,s){"use strict";s.r(e);var a=s(43),r=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"terraform"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#terraform"}},[t._v("#")]),t._v(" Terraform")]),t._v(" "),s("p",[t._v("Infrastructure as Code (IaC) is a way to define what resources & configuration you need to run an application. These declarations can then be stored in git. This approach eliminates the potential for human error when setting up multiple servers & configuration drift between environments.")]),t._v(" "),s("p",[t._v("All cloud resources in the prod & nonprod environments must be created as IaC, and account permissions will reflect this policy.")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.terraform.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Terraform"),s("OutboundLink")],1),t._v(" is the vendor-agnostic IaC tool that Administrative Systems uses. When you write your IaC, terraform will determine which service providers you need and will automatically download the appropriate "),s("a",{attrs:{href:"https://www.terraform.io/docs/providers/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("provider drivers"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("For the most part, AS developers will only need to be concerned with the "),s("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("AWS provider"),s("OutboundLink")],1),t._v(". But if the need arises, you can use terraform to build infrastructure for one app across several cloud vendors.")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Terraform Version")]),t._v(" "),s("p",[t._v("Prior to January 2020, we used Terraform v0.10. We are in the process of migrating to TF 0.12.")]),t._v(" "),s("p",[t._v("All new IaC development should be done using TF 0.12. We recommend installing "),s("a",{attrs:{href:"https://github.com/tfutils/tfenv",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("tfenv")]),s("OutboundLink")],1),t._v(" to manage your TF versions.")]),t._v(" "),s("p",[t._v("You should upgrade your older modules to v0.12 -- see the AS "),s("RouterLink",{attrs:{to:"/iac/tf-upgrading.html"}},[t._v("upgrade guide")]),t._v(" for guidance.")],1)]),t._v(" "),s("h2",{attrs:{id:"concepts"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#concepts"}},[t._v("#")]),t._v(" Concepts")]),t._v(" "),s("p",[t._v("A simple terraform module is made up of three parts: provider blocks, a backend, and the infrastructure resources you want.")]),t._v(" "),s("div",{staticClass:"language-hcl extra-class"},[s("pre",{pre:!0,attrs:{class:"language-hcl"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Provider Block")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# --------------")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Declares that we need the AWS provider and sets a default region.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The version argument tells TF that it should use any stable v2.27.x provider.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("provider"),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v(' "aws" ')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("region")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"us-east-2"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("version")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"~> 2.27"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Backend Block")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -------------")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This block tells Terraform that it should remember what")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# resources it has created using a file in an S3 bucket.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("terraform")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("backend"),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v(' "s3" ')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("bucket")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"accountName-nonprod-build-tfstate"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("key")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"accountName-shared-resources/nonprod/terraform.tfstate"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("region")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"us-east-2"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Resource Blocks")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ---------------")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Creates a Simple Notification Service topic")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_sns_topic"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"opsgenie_alert_topic"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("name")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OpsGenie-SomeTeam"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Adds OpsGenie's alert API as a subscriber to that topic,")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# using the Amazon Resource Name (ARN) that the previous resource")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# output.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),s("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_sns_topic_subscription"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"opsgenie_integration"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("topic_arn")]),t._v("              "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" aws_sns_topic.opsgenie_alert_topic.arn"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\n  protocol               = "')]),t._v("https"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\n  endpoint               = "')]),t._v("https:"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//api.opsgenie.com/alert/SomeTeam?apiKey=MyVeryCoolSecret"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("endpoint_auto_confirms")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("Terraform will automatically determine that it needs to create the topic before it can create the subscription, since the subscription is using an "),s("em",[t._v("attribute")]),t._v(" (the ARN) from the topic resource.")]),t._v(" "),s("p",[t._v("Every resource is different. The terraform AWS provider documentation will explain what arguments (inputs) & attributes (outputs) are available. For example, the "),s("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/sns_topic.html",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("aws_sns_topic")]),s("OutboundLink")],1),t._v(" documentation tells us that we could set a "),s("code",[t._v("display_name")]),t._v(" argument too.")]),t._v(" "),s("h2",{attrs:{id:"developing-testing-iac"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#developing-testing-iac"}},[t._v("#")]),t._v(" Developing & Testing IaC")]),t._v(" "),s("p",[t._v("Before you begin, you should install the "),s("a",{attrs:{href:"https://marketplace.visualstudio.com/items?itemName=mauve.terraform",target:"_blank",rel:"noopener noreferrer"}},[t._v("terraform extension for VS Code"),s("OutboundLink")],1),t._v(". This will give you a code formatter, syntax highlighting, tab completion, and quick navigation.")]),t._v(" "),s("p",[t._v("You may check your TF code compiles with the "),s("code",[t._v("terraform validate")]),t._v(" command. You will need to "),s("code",[t._v("terraform init")]),t._v(" your module beforehand. If the "),s("code",[t._v("init")]),t._v(" gives you errors about the S3 bucket, that is OK: the state bucket is only needed when you are planning/deploying/destroying.")]),t._v(" "),s("p",[t._v("Infrastructure in the nonprod & prod accounts may only be created by terraform running on your Jenkins server -- your own AWS login will not be able to create anything. If you wish to test terraform from your own machine, you can log in to the sandbox with the "),s("a",{attrs:{href:"https://github.com/venth/aws-adfs",target:"_blank",rel:"noopener noreferrer"}},[t._v("aws-adfs"),s("OutboundLink")],1),t._v(" utility.")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("`aws-adfs` & Duo")]),t._v(" "),s("p",[t._v("Before using the "),s("code",[t._v("aws-adfs")]),t._v(" utility, you will need to configure Duo to automatically send you push notifications.")]),t._v(" "),s("p",[t._v("When logging in to "),s("a",{attrs:{href:"https://aws.northwestern.edu",target:"_blank",rel:"noopener noreferrer"}},[t._v("aws.northwestern.edu"),s("OutboundLink")],1),t._v(", hit the "),s("em",[t._v("Settings")]),t._v(" tab on your Duo popup, then "),s("em",[t._v("My Settings & Devices")]),t._v(".")]),t._v(" "),s("p",[t._v("Choose "),s("em",[t._v("Automatically Send this Device a Duo Push")]),t._v(" to enable this functionality.")])]),t._v(" "),s("p",[t._v("Once installed, you can run the utility with the below arguments. Your username should be in the format "),s("code",[t._v("ads\\netid")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("aws-adfs login --adfs-host"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ads-fed.northwestern.edu --provider-id urn:amazon:webservices --region us-east-2 --no-sspi\n")])])]),s("p",[t._v("Once logged in, the utility will prompt you to choose the AWS account to use.")]),t._v(" "),s("h2",{attrs:{id:"more-about-configuring-profiles-in-the-aws-adfs-utility"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#more-about-configuring-profiles-in-the-aws-adfs-utility"}},[t._v("#")]),t._v(" More About Configuring Profiles in the AWS-ADFS Utility")]),t._v(" "),s("p",[t._v("The aws-adfs utility facilitates logging you into AWS and it places your temporary credential information in your .aws/credentials files where many other applications (including terraform) know where to look and how to use it. In short, it logs into an AWS account on your behalf during the upload.")]),t._v(" "),s("p",[t._v("A default profile is established based on the first AWS account you use without specifically designating a profile name. Note that you can always delete your default via the reset command and establish another one. (See below.)")]),t._v(" "),s("p",[t._v("In addition to a default profile, you can create a profile for each AWS account that you use.")]),t._v(" "),s("p",[t._v("There are three commands that you will need in order to work with profiles:")]),t._v(" "),s("p",[s("strong",[t._v("1. aws-adfs list")])]),t._v(" "),s("p",[t._v("Use this to list the details of all your profiles, including the default.")]),t._v(" "),s("p",[s("strong",[t._v("2. --profile {YourProfileName}")])]),t._v(" "),s("p",[t._v("This is added to the standard utility statement both to create a profile and to use that profile after it is created.\nOnce you have entered the standard utility statement with a new profile name, you will see a numbered list of all AWS account to which you have access.\nEnter the number of the account that you want to associate with the profile name you entered. From that point forward, that profile name is mapped to the account you selected.")]),t._v(" "),s("p",[s("em",[t._v("For Example")])]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("aws-adfs login --adfs-host"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ads-fed.northwestern.edu --provider-id urn:amazon:webservices --region us-east-2 **--profile YourProfileName**\n")])])]),s("p",[s("strong",[t._v("3. aws-adfs reset --profile YourProfileName")])]),t._v(" "),s("p",[t._v("Use this to delete the named profile from the list.")]),t._v(" "),s("h2",{attrs:{id:"shortcut-configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#shortcut-configuration"}},[t._v("#")]),t._v(" Shortcut Configuration")]),t._v(" "),s("p",[t._v("The utility code listed above can become tedious. To shorten the process, use follow the instructions below to install a function within your bash profile that clears the current profile and sets your newly entered profile.")]),t._v(" "),s("ol",[s("li",[t._v("Open bash editor:   vi ~/.bash_profile")]),t._v(" "),s("li",[t._v("Enter i to insert")]),t._v(" "),s("li",[t._v("Paste in the following code:")])]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" aws-adfs-"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("login")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("                                                                                     \n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("unset")]),t._v(" AWS_PROFILE\n\taws-adfs login --adfs-host"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ads-fed.northwestern.edu --provider-id urn:amazon:webservices --profile "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" --no-sspi\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_PROFILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[t._v("Enter [esc] to exit insert mode")]),t._v(" "),s("li",[t._v("Enter [shift]zz to save and close")]),t._v(" "),s("li",[t._v("If you are using linux, enter:   "),s("strong",[t._v("source ~/.bash_profile")])]),t._v(" "),s("li",[t._v("To use a profile, enter the function and profile name:  "),s("strong",[t._v("aws-adfs-login [YourProfileName]")])]),t._v(" "),s("li",[t._v("To see all your profiles, enter: "),s("strong",[t._v("aws-adfs list")])])])])}),[],!1,null,null,null);e.default=r.exports}}]);