(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{355:function(t,s,a){t.exports=a.p+"assets/img/jenkins-cred-list.a0014506.png"},356:function(t,s,a){t.exports=a.p+"assets/img/jenkins-cred-entry.284f553d.png"},393:function(t,s,a){"use strict";a.r(s);var e=a(43),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"secret-management"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#secret-management"}},[t._v("#")]),t._v(" Secret Management")]),t._v(" "),e("p",[t._v("Secrets like usernames, passwords, API keys, and private keys should be kept in Jenkins. They should not be hard-coded and included in a "),e("RouterLink",{attrs:{to:"/github/policies.html#secrets"}},[t._v("GitHub repository")]),t._v(", nor hard-coded into Jenkins pipelines or Docker images.")],1),t._v(" "),e("p",[t._v("Jenkins cannot share its credential store with other applications & services, but provides a convenient way for developers to manage secrets right alongside their infrastructure and app builds. To faciliate using credentials, the secrets kept in Jenkins should be published to the AWS Systems Manager (SSM) Paramater Store as encrypted values.")]),t._v(" "),e("p",[t._v("The SSM paramater store securely store secrets for use by your apps and other infrastructure. It has first-class integration for some services -- for example, the Elastic Container Service (ECS) can "),e("a",{attrs:{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("decrypt and inject secrets from SSM automatically upon booting a container"),e("OutboundLink")],1),t._v(". For services that do not offer this integration, the AWS SDK can be used to access & decrypt secrets in your application code.")]),t._v(" "),e("p",[t._v("The SSM parameter store can hold other, not-secret config values too. That is beyond the scope of this article.")]),t._v(" "),e("h2",{attrs:{id:"strategy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#strategy"}},[t._v("#")]),t._v(" Strategy")]),t._v(" "),e("p",[t._v("All Jenkins jobs are sorted into folders. Folders provide a security boundry for credentials: "),e("em",[t._v("only")]),t._v(" jobs inside a folder can access credentials scoped to the folder. This way, an 'HR Enterprise' job would not have access to a 'Student Enterprise' credential. Groups of developers can be assigned permission to create/update/delete credentials for their folders.")]),t._v(" "),e("p",[t._v("There is a working demo of this strategy available in the "),e("a",{attrs:{href:"https://github.com/NIT-Administrative-Systems/jenkins-credential-sync-test",target:"_blank",rel:"noopener noreferrer"}},[t._v("jenkins-credential-sync-test repository"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("h3",{attrs:{id:"jenkins-setup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-setup"}},[t._v("#")]),t._v(" Jenkins Setup")]),t._v(" "),e("p",[t._v("To create credentials in Jenkins, click into your folder > Credentials > Folder, and then select Global Credentials. You can add or update the credentials here.")]),t._v(" "),e("p",[e("img",{attrs:{src:a(355),alt:"Jenkins credential list screen"}})]),t._v(" "),e("p",[t._v("When creating a credential, choose the secret text type. Make sure you specify the ID as a name you'll use for the SSM parameter. If you do not specify the ID, Jenkins will generate a UUID. You can go back and edit that so it's a descriptive label.")]),t._v(" "),e("p",[e("img",{attrs:{src:a(356),alt:"Jenkins credential entry screen"}})]),t._v(" "),e("h3",{attrs:{id:"terraform-setup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#terraform-setup"}},[t._v("#")]),t._v(" Terraform Setup")]),t._v(" "),e("p",[t._v("The SSM parameter resources should be created by Terraform as IaC. The easiest way to do this is specifying a template resource and putting your parameter names in an array. The parameter names should be emitted as an output from your Terraform modules.")]),t._v(" "),e("p",[t._v("You may optionally create an application-specific encryption key for your secrets. This is free and has no downsides, so it is recommended to do so.")]),t._v(" "),e("div",{staticClass:"language-hcl extra-class"},[e("pre",{pre:!0,attrs:{class:"language-hcl"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Make this a list of your secrets. These names should match the Jenkins credential IDs.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("locals")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("parameters")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jcst-demo-api-key"')]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jcst-password"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This will create two resources; one for each entry in the parameters array.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# You should customize the name for your app. ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# SSM is a a hierarchy, so "/your-app/env" is a good prefix!')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_ssm_parameter"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secure_param"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("count")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" length(local.parameters)\n\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("name")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/jenkins-ssm-sync/tech-demo/'),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v("parameters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("count")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v("index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("description")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Demo secret: '),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v("parameters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("count")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v("index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("type")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SecureString"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("value")]),t._v("       "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SSM parameter store not populated from Jenkins"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("key_id")]),t._v("      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" aws_kms_key.key.arn\n\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("tags")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("environment")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tech-demo"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The parameter will be created with a dummy value. Jenkins will update it with ")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the final value in a subsequent pipeline step.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# TF will not override the parameter once it has been created.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lifecycle")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("ignore_changes")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("output"),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v(' "parameters" ')])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("value")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" zipmap(local.parameters, slice(aws_ssm_parameter.secure_param.*.name, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", length(local.parameters)))\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_kms_key"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("description")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Key for encrypting demo config"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("This will create two encrypted SSM parameters with dummy values.")]),t._v(" "),e("h3",{attrs:{id:"pipeline"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pipeline"}},[t._v("#")]),t._v(" Pipeline")]),t._v(" "),e("p",[t._v("As part of your pipeline, you will want to call the "),e("RouterLink",{attrs:{to:"/ci-cd/shared-libs.html"}},[e("code",[t._v("publishSecretsToSSM")]),t._v(" function from our shared Jenkins library")]),t._v(".")],1),t._v(" "),e("p",[t._v("You should do this in your infrastructure pipeline: the function depends on the Terraform module being initialized & applied, with the "),e("code",[t._v("parameters")]),t._v(" output available. If your application has strong reasons to do this in another pipeline, ensure the infrastructure module has been "),e("code",[t._v("terraform init")]),t._v("-ed first.")]),t._v(" "),e("div",{staticClass:"language-groovy extra-class"},[e("pre",{pre:!0,attrs:{class:"language-groovy"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang comment"}},[t._v("#!groovy")]),t._v("\nlibrary identifier"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"AS-jenkins-shared@stable"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" retriever"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("modernSCM")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GitSCMSource'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" credentialsId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GitHub-awsCloudOpsCJT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remote"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://github.com/NIT-Administrative-Systems/AS-jenkins-shared.git'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\npipeline "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    agent any\n\n    stages "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        stage "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Terraform'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            sh "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tfenv install && terraform -version'")]),t._v("\n            sh "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'terraform init -no-color'")]),t._v("\n            sh "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'terraform apply -no-color -auto-approve'")]),t._v("\n            sh "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'terraform output -no-color'")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        stage "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Publish Secrets to SSM'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            steps "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This function is part of our shared library")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("publishSecretsToSSM")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'us-east-2'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dev/'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])])]),e("h2",{attrs:{id:"using-secrets"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#using-secrets"}},[t._v("#")]),t._v(" Using Secrets")]),t._v(" "),e("p",[t._v("Here are some notes on common ways to use SSM secrets.")]),t._v(" "),e("p",[t._v("In all cases, the service will need to be given access to the KMS key before it can decrypt parameters -- granting your application access to an encrypted SSM parameter without the key will result in errors when you attempt to access the secret!")]),t._v(" "),e("p",[t._v("Here is an example policy, based on the parameter example above:")]),t._v(" "),e("div",{staticClass:"language-hcl extra-class"},[e("pre",{pre:!0,attrs:{class:"language-hcl"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("data "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_iam_policy_document"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lambda_secrets_policy"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("statement")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("effect")]),t._v("    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("actions")]),t._v("   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssm:GetParameters"')]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ssm:GetParameter"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("resources")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" aws_ssm_parameter.secure_param.*.arn\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("statement")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("effect")]),t._v("    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("actions")]),t._v("   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kms:Decrypt"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("resources")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("aws_kms_key.key.arn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_iam_role_policy"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lambda_secrets_policy"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("name")]),t._v("   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SomeApp-Env-Secrets"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("policy")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" data.aws_iam_policy_document.lambda_secrets_policy.json\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Your Lambda/ECS/etc execution role name")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("role")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('". . ."')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"in-the-console"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#in-the-console"}},[t._v("#")]),t._v(" In the Console")]),t._v(" "),e("p",[t._v("By default, the KMS encryption key that you create will not be usable. You will grant your Lambda/ECS/etc "),e("code",[t._v("kms:Decrypt")]),t._v(" access, but if you want to review your secrets in the console or use them from the CLI, there is an additional step -- granting the developer role you access AWS with access.")]),t._v(" "),e("p",[t._v("To avoid exposing secrets to other teams in your department, this access it not automatically granted. The "),e("a",{attrs:{href:"#using-secrets"}},[t._v("example IAM policy above")]),t._v(" could specify your login group's name instead of an execution role name, in order to enable decryption in the AWS Console.")]),t._v(" "),e("div",{staticClass:"language-hcl extra-class"},[e("pre",{pre:!0,attrs:{class:"language-hcl"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("data "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_iam_role"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"developers"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("name")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"as-ado-sbx-Devs-EACD"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resource "),e("span",{pre:!0,attrs:{class:"token type variable"}},[t._v('"aws_iam_role_policy"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lambda_secrets_policy"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("name")]),t._v("   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SomeApp-SomeEnv-DeveloperDecryptSecrets"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("role")]),t._v("   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" data.aws_iam_role.developers.name\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v("policy")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" data.aws_iam_policy_document.lambda_secrets_policy.json\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("The IAM article "),e("RouterLink",{attrs:{to:"/infrastructure/iam.html#developer-roles"}},[t._v("has a list of available roles")]),t._v(".")],1),t._v(" "),e("h3",{attrs:{id:"ecs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ecs"}},[t._v("#")]),t._v(" ECS")]),t._v(" "),e("p",[t._v("In your ECS "),e("a",{attrs:{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("task definition"),e("OutboundLink")],1),t._v(", you can specify a "),e("code",[t._v("secrets")]),t._v(" section with the ARNs for your parameters. They will automatically be decrypted and injected into your container as environment variables when it is started:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"cpu"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"memory"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my-cool-task"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"portMappings"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"containerPort"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hostPort"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"essential"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"image"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${aws_ecr_repository.my_ecr.repository_url}:latest"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"secrets"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${local.ssm_params[0]}"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"valueFrom"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${aws_ssm_parameter.secure_param.0.arn}"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"lambda"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#lambda"}},[t._v("#")]),t._v(" Lambda")]),t._v(" "),e("p",[t._v("Lambda does not have a native integration for SSM parameters. However, AWS offers SDKs for most languages: Python, Java, PHP, etc. that are all similar.")]),t._v(" "),e("p",[t._v("Here is an example using the AWS Javascript SDK:")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AWS")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aws-sdk'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ssm "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AWS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SSM")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  region"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'us-east-2'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ssmResponse "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" ssm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getParameter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Name"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/jenkins-ssm-sync/tech-demo/jcst-password'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    WithDecryption"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("promise")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ssmResponse"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Parameter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("If you are scheduling a Lambda to be run through CloudWatch or a Step Function, you can use Terraform to inject the full parameter name into the event that invokes the Lambda. Then you won't need to worry about keeping the parameter names in sync between SSM and your codebase.")])])}),[],!1,null,null,null);s.default=n.exports}}]);