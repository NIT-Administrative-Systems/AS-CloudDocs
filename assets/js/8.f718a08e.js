(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{355:function(t,e,n){t.exports=n.p+"assets/img/branch-discovery.a640c64b.png"},375:function(t,e,n){"use strict";n.r(e);var s=n(41),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"jenkins-pipelines"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-pipelines"}},[t._v("#")]),t._v(" Jenkins Pipelines")]),t._v(" "),s("p",[t._v("A Jenkins pipeline is a script that takes your application from version control to deployment. The pipeline file is kept in your application's Github repository, follows normal pull request review procedure, and is promoted from dev/qa/prod using the same process as your code.")]),t._v(" "),s("p",[t._v('Jenkins pipelines have several flavours. Unless you have reason to deviate, our standards are multi-branch declarative pipelines. Multi-branch pipelines will detect all branches & pull requests and run them inside the "parent" job: perfect for running tests or deploying dev/qa environments. There may be cases where this is '),s("em",[t._v("not")]),t._v(" appropriate, such as a pipeline that runs on a schedule and kicks off a scheduled deployment.")]),t._v(" "),s("p",[t._v("Documentation on the declarative Jenkinsfile syntax can be found "),s("a",{attrs:{href:"https://jenkins.io/doc/book/pipeline/syntax/",target:"_blank",rel:"noopener noreferrer"}},[t._v("on the Jenkins website"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Legacy Jenkins Jobs")]),t._v(" "),s("p",[t._v("If you have used Jenkins in the past, you may be familiar with configuring jobs.")]),t._v(" "),s("p",[t._v("These legacy-style jobs should be replaced by pipelines files kept in version control. No new jobs should be configured this way.")])]),t._v(" "),s("p",[t._v("We typically keep pipeline files in a "),s("code",[t._v(".jenkins/")]),t._v(" folder. Even if you only have a single Jenkinsfile, it is advisable to put it in the folder; changing it later is a nuisance.")]),t._v(" "),s("h2",{attrs:{id:"accessing-github-repositories"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#accessing-github-repositories"}},[t._v("#")]),t._v(" Accessing GitHub Repositories")]),t._v(" "),s("p",[t._v("Jenkins must authenticate to GitHub.com as a user in order to clone code. This user must be a collaborator on the repository that you want Jenkins to work with.")]),t._v(" "),s("p",[t._v("All Jenkins servers have the "),s("a",{attrs:{href:"#credentials"}},[s("code",[t._v("GitHub-awsCloudOpsCJT")])]),t._v(" credential for the "),s("a",{attrs:{href:"https://github.com/awsCloudOpsCJT",target:"_blank",rel:"noopener noreferrer"}},[t._v("awsCloudOpsCJT user"),s("OutboundLink")],1),t._v(" that may be used. You may create a user specifically for your team if you want to more tightly control access to your repositories. Creating a team-specific user is recommended if you will be granting it write permission so Jenkins can update "),s("a",{attrs:{href:"https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-status-checks",target:"_blank",rel:"noopener noreferrer"}},[t._v("commit statuses"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("If you need awsCloudOpsCJT or a team-specific user added as a collaborator, contact the EACD-CloudOps group -- self-service tooling for this is not available yet, sorry!")]),t._v(" "),s("h2",{attrs:{id:"configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[t._v("#")]),t._v(" Configuration")]),t._v(" "),s("p",[t._v("As much configuration as possible should be included in the Jenkinsfile.")]),t._v(" "),s("ul",[s("li",[t._v("Review the "),s("a",{attrs:{href:"https://jenkins.io/doc/book/pipeline/syntax/#options",target:"_blank",rel:"noopener noreferrer"}},[t._v("options"),s("OutboundLink")],1),t._v(" section\n"),s("ul",[s("li",[s("code",[t._v("disableConcurrentBuilds()")]),t._v(" is a commonly-used option; you wouldn't want to "),s("code",[t._v("terraform apply")]),t._v(" off the same tfstate file at the same time.")])])]),t._v(" "),s("li",[t._v("Review the "),s("a",{attrs:{href:"https://jenkins.io/doc/book/pipeline/syntax/#triggers",target:"_blank",rel:"noopener noreferrer"}},[t._v("triggers"),s("OutboundLink")],1),t._v(" section\n"),s("ul",[s("li",[s("code",[t._v("pollSCM('H/10 * * * *')")]),t._v(" is popular; Jenkins is firewalled off so Github cannot notify it when code is pushed")])])]),t._v(" "),s("li",[t._v("Review the "),s("a",{attrs:{href:"https://jenkins.io/doc/book/pipeline/syntax/#parameters",target:"_blank",rel:"noopener noreferrer"}},[t._v("parameters"),s("OutboundLink")],1),t._v(" section, if you need inputs")])]),t._v(" "),s("p",[t._v("The most notable item that you cannot include is branch discovery for a multi-branch pipeline. This must be configured in the Jenkins UI:")]),t._v(" "),s("p",[s("img",{attrs:{src:n(355),alt:"Branch discovery settings"}})]),t._v(" "),s("h2",{attrs:{id:"credentials"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#credentials"}},[t._v("#")]),t._v(" Credentials")]),t._v(" "),s("p",[t._v("Jenkins has a credential store that your pipelines may access. These credentials are items necessary for deployments.")]),t._v(" "),s("p",[t._v("Out of the box, three credentials will exist:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("terraform")]),t._v(", an AWS credential for creating resources via Terraform")]),t._v(" "),s("li",[s("code",[t._v("teams-build-webhook")]),t._v(", the URL for posting status messages to Teams")]),t._v(" "),s("li",[s("code",[t._v("GitHub-awsCloudOpsCJT")]),t._v(", a Github user in our organization")])]),t._v(" "),s("p",[t._v("You can ask the EACD-CloudOps group for help if you need to add pipeline-specific secrets to your Jenkins servers.")]),t._v(" "),s("h2",{attrs:{id:"agents"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#agents"}},[t._v("#")]),t._v(" Agents")]),t._v(" "),s("p",[t._v("By default, a pipeline will run on the main Jenkins server. It will have the tools available on a fairly standard CentOS Linux installation, plus the "),s("code",[t._v("terraform")]),t._v(" binary and docker CLI tools.")]),t._v(" "),s("p",[t._v("If you need more specialized tools -- specific versions of NodeJS for example -- you can use a Docker agent instead:")]),t._v(" "),s("div",{staticClass:"language-groovy extra-class"},[s("pre",{pre:!0,attrs:{class:"language-groovy"}},[s("code",[t._v("agent "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        image "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node:10'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("You can choose an agent for your pipeline file or for specific stages. Jenkins will download the Docker image from Docker Hub and execute your pipeline inside of that container. If no community-maintained image is available for your needs, you can write your own Dockerfile and use it as the agent as well.")]),t._v(" "),s("h3",{attrs:{id:"heavy-tasks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#heavy-tasks"}},[t._v("#")]),t._v(" Heavy Tasks")]),t._v(" "),s("p",[t._v("For small units of work, running things on the Jenkins server is fine. However, when running more computationally-expensive pipelines, you are liable to consume all available CPU/memory. Jenkins may become unresponsive, unable to run additional tasks, or crash.")]),t._v(" "),s("p",[t._v("Instructions on offloading to dedicated worker hosts can be found in the "),s("RouterLink",{attrs:{to:"/ci-cd/jenkins-ecs-agent.html"}},[t._v("Jenkins ECS Agent")]),t._v(" article. The EACD-CloudOps group may request you convert some pipeline(s) to using an ECS agent as problems are discovered.")],1),t._v(" "),s("h2",{attrs:{id:"example-pipeline"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#example-pipeline"}},[t._v("#")]),t._v(" Example Pipeline")]),t._v(" "),s("p",[t._v("This is an example pipeline for testing a PHP 7.4 application. The entire pipeline runs in a community-maintained Docker image pulled in from Docker Hub. Jenkins will scan GitHub for any new commits every 10 minutes, and kick the pipeline off for any new/changed branches. When it runs, it will ping a Teams channel. If the build succeeds or fails, a follow-up will be posted to Teams.")]),t._v(" "),s("p",[t._v("The very first line ("),s("code",[t._v("#!groovy")]),t._v(") is a trick we use to get correct syntax highlighting in VSCode. It has no other effect.")]),t._v(" "),s("div",{staticClass:"language-groovy extra-class"},[s("pre",{pre:!0,attrs:{class:"language-groovy"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang comment"}},[t._v("#!groovy")]),t._v("\npipeline "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    agent "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        docker "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            image "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'edbizarro/gitlab-ci-pipeline-php:7.4'")]),t._v("\n            args "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-u root:root'")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    environment "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        TEAMS_WEBHOOK_URL "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("credentials")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'teams-build-webhook'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    triggers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pollSCM")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'H/10 * * * *'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n    options "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("disableConcurrentBuilds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    stages "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        stage "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Send Notifications'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            steps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                office365ConnectorSend status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"Started"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" webhookUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TEAMS_WEBHOOK_URL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        stages "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            stage "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                steps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    sh "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'composer install'")]),t._v("\n                    sh "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./vendor/bin/phpunit'")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    post "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        success "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            office365ConnectorSend status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"Success!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" webhookUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TEAMS_WEBHOOK_URL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        failure "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            office365ConnectorSend status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"Failed"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" webhookUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TEAMS_WEBHOOK_URL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"scheduling-deployments"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scheduling-deployments"}},[t._v("#")]),t._v(" Scheduling Deployments")]),t._v(" "),s("p",[t._v("You must regularly re-deploy your application. Our minimum is once per week, but more frequent deployments are encouraged.")]),t._v(" "),s("p",[t._v("Re-deploying on a schedule, even when no changes are pending deployment, ensures that your pipeline & deployment process is valid. Some applications may go into a period of development inactivity; it's good to know that you can apply a critical security patch without worrying if your pipeline still works after not being used for nine months.")]),t._v(" "),s("p",[t._v("You can create a pair of regular (not multi-branch) pipelines that trigger your main Jenkinsfile's develop/qa & production branch builds.")]),t._v(" "),s("p",[t._v("Here is an example Jenkinsfile that will schedule itself to run every day at noon. When it runs, it will trigger a build for the "),s("code",[t._v("develop")]),t._v(" branch in the "),s("code",[t._v("OnBase SSO Shim")]),t._v(" multi-branch pipeline. This way, it's using the exact same deployment process as when changes are pushed to "),s("code",[t._v("develop")]),t._v(". Once that run is done, it will do the same for the "),s("code",[t._v("qa")]),t._v(" branch:")]),t._v(" "),s("div",{staticClass:"language-groovy extra-class"},[s("pre",{pre:!0,attrs:{class:"language-groovy"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang comment"}},[t._v("#!groovy")]),t._v("\npipeline "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    agent any\n\n    triggers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cron")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'H 12 * * *'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    stages "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        stage "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Deploy Sub-production'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            steps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'OnBase SSO Shim/develop'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("job"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'OnBase SSO Shim/qa'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);e.default=a.exports}}]);