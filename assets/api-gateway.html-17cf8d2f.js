import{_ as r,M as t,p,q as l,R as a,t as e,N as n,V as c,a1 as o}from"./framework-bf3e1922.js";const d={},u=a("h1",{id:"api-gateway",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#api-gateway","aria-hidden":"true"},"#"),e(" API Gateway")],-1),h={href:"https://docs.aws.amazon.com/apigateway/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://cloud.google.com/apigee/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html",target:"_blank",rel:"noopener noreferrer"},g=a("p",null,"Wherever possible, it is recommended to use the simplified HTTP API service instead of the classic v1 REST API service. The v1 service is still required for websocket support, but that is an uncommon use-case for Admin Systems.",-1),y=a("h2",{id:"usage",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#usage","aria-hidden":"true"},"#"),e(" Usage")],-1),_=a("p",null,"Our typical use-case for API Gateway is as the load balancer for serverless APIs running on Lambda. We do not use most of the features it offers: documentation, API key management, rate limiting, and request/response re-writing are all handled in Apigee.",-1),w={href:"https://docs.amazonaws.cn/en_us/apigateway/latest/developerguide/limits.html",target:"_blank",rel:"noopener noreferrer"},b={href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html",target:"_blank",rel:"noopener noreferrer"},k={href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html",target:"_blank",rel:"noopener noreferrer"},f=o(`<p>This is what you will need to set up an HTTP API for API Gateway that sends all HTTP requests to one Lambda:</p><div class="language-hcl line-numbers-mode" data-ext="hcl"><pre class="language-hcl"><code><span class="token keyword">resource <span class="token type variable">&quot;aws_apigatewayv2_api&quot;</span></span> <span class="token string">&quot;http_api&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>          <span class="token punctuation">=</span> local.application_name
  <span class="token property">protocol_type</span> <span class="token punctuation">=</span> <span class="token string">&quot;HTTP&quot;</span>

  <span class="token property">target</span> <span class="token punctuation">=</span> aws_lambda_function.api.arn
  <span class="token property">route_key</span> <span class="token punctuation">=</span> <span class="token string">&quot;$default&quot;</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> local.tags
<span class="token punctuation">}</span>

<span class="token comment"># API Gateway is allowed to invoke the Lambda</span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_lambda_permission&quot;</span></span> <span class="token string">&quot;allow_http_api&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">action</span>        <span class="token punctuation">=</span> <span class="token string">&quot;lambda:InvokeFunction&quot;</span>
  <span class="token property">function_name</span> <span class="token punctuation">=</span> aws_lambda_function.api.arn
  <span class="token property">principal</span>     <span class="token punctuation">=</span> <span class="token string">&quot;apigateway.amazonaws.com&quot;</span>
  <span class="token property">source_arn</span>    <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_apigatewayv2_api<span class="token punctuation">.</span>http_api<span class="token punctuation">.</span>execution_arn<span class="token punctuation">}</span></span>/*/$default&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),A={href:"https://github.com/NIT-Administrative-Systems/AS-serverless-api-IaC",target:"_blank",rel:"noopener noreferrer"},I=a("h3",{id:"apigee",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#apigee","aria-hidden":"true"},"#"),e(" Apigee")],-1),P=a("p",null,"APIs should be registered in our API management platform, Apigee.",-1),T={href:"https://apiserviceregistry.northwestern.edu/documentation/producer/prod-awssetup.html",target:"_blank",rel:"noopener noreferrer"},q=a("p",null,[e("Apigee's "),a("code",null,"{env}.api.northwestern.edu"),e(" hostname allows developers to skip the time-consuming process of setting up a custom domain & issuing a certificate for API Gateway. Since Apigee can provide a "),a("code",null,"*.northwestern.edu"),e(" hostname, authenticating individual users with SSO from an SPA against an Apigee endpoint is possible.")],-1),x={href:"https://en.wikipedia.org/wiki/Mashup_(web_application_hybrid)",target:"_blank",rel:"noopener noreferrer"},G={href:"https://www.gartner.com/document/3980382",target:"_blank",rel:"noopener noreferrer"},S=a("code",null,"*.northwestern.edu",-1),z=a("h2",{id:"deployments",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#deployments","aria-hidden":"true"},"#"),e(" Deployments")],-1),E=a("div",{class:"hint-container warning"},[a("p",{class:"hint-container-title"},"API Gateway v1 (REST API) Advice"),a("p",null,"This advice is only applicable to v1 REST APIs for API Gateway product. It is not relevant to HTTP APIs."),a("p",null,"This section is maintained because we have legacy API Gateway deployments that pre-date the HTTP API product.")],-1),H={href:"https://www.terraform.io/docs/providers/aws/r/api_gateway_deployment.html",target:"_blank",rel:"noopener noreferrer"},R=o(`<p>This can be achived by adding a variable with the current time. Terraform will always re-deploy the API when <code>terraform apply</code> is run:</p><div class="language-hcl line-numbers-mode" data-ext="hcl"><pre class="language-hcl"><code><span class="token keyword">resource <span class="token type variable">&quot;aws_api_gateway_deployment&quot;</span></span> <span class="token string">&quot;deployment&quot;</span> <span class="token punctuation">{</span>
    <span class="token comment"># Other parameters . . .</span>

    <span class="token keyword">variables</span> <span class="token punctuation">{</span>
        <span class="token comment"># Ensures TF re-deploys w/ the new timestamp every time it runs</span>
        <span class="token property">deployed_at</span> <span class="token punctuation">=</span> timestamp()
    <span class="token punctuation">}</span>

    <span class="token keyword">lifecycle</span> <span class="token punctuation">{</span>
        <span class="token property">create_before_destroy</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2);function L(N,V){const s=t("ExternalLinkIcon"),i=t("RouterLink");return p(),l("div",null,[u,a("p",null,[e("The AWS "),a("a",h,[e("API Gateway"),n(s)]),e(" is Amazon's serverless platform for API development and delivery. It has many features found in "),a("a",m,[e("Apigee"),n(s)]),e(", and can be used to similar purpose.")]),a("p",null,[e("Amazon has a simplified and less-expensive version of API Gateway in beta, called "),a("a",v,[e("HTTP APIs"),n(s)]),e(". It drops support for most of the features we already rely on Apigee for.")]),g,y,_,a("p",null,[e("API Gateway imposes a 29-second max on requests. If you have some requests that may exceed this limitation, API Gateway is not appropriate for your use-case. There are "),a("a",w,[e("other limitations"),n(s)]),e(" on maximumn request/response size (and a number of other items) that should be reviewed before deciding to use API Gateway. "),n(i,{to:"/infrastructure/alb.html"},{default:c(()=>[e("ALBs")]),_:1}),e(" can get around most of these limitations, but are an always-on service.")]),a("p",null,[e("In the past, we have created individual REST API resources in API Gateway. This has created complexity without giving us much value. Going forward, it is recommended that you create "),a("a",b,[e("simple API Gateway proxies"),n(s)]),e(" and handle routing/authorization in your application using "),a("a",k,[e("HTTP APIs"),n(s)]),e(" instead of the more-complex REST API product.")]),f,a("p",null,[e("A more complete example for a NodeJS microservice is available in the "),a("a",A,[e("AS-serverless-api-IaC"),n(s)]),e(" repository.")]),I,P,a("p",null,[e("Most of our APIs have been machine-to-machine integrations. We set up a single API key per environment in API Gateway. This allows Apigee to authenticate to the API. Further restriction on a per-application basis is handled in Apigee. The API Service Registry "),a("a",T,[e("has instructions on setting this up"),n(s)]),e(" on the Apigee side.")]),q,a("p",null,[e("Services being available to other developers for "),a("a",x,[e("mashup-"),n(s)]),e(" or "),a("a",G,[e("MASA-"),n(s)]),e("style apps is highly valued by AS leadership, so making API endpoints available from a "),S,e(" hostname is key.")]),z,E,a("p",null,[e("The API Gateway configuration must be deployed before it goes into effect. You need an "),a("a",H,[e("API Gateway Deployment resource"),n(s)]),e(" in Terraform to trigger the deployment. However, Terraform only deploys changed resources -- it needs to see a change with the deployment in order to trigger and re-deploy your API Gateway settings.")]),R])}const C=r(d,[["render",L],["__file","api-gateway.html.vue"]]);export{C as default};
