import{_ as a,p as s,q as n,Q as t,a1 as e}from"./framework-bf3e1922.js";const o={},c=e(`<h1 id="terraform-state-move" tabindex="-1"><a class="header-anchor" href="#terraform-state-move" aria-hidden="true">#</a> Terraform State Move</h1><p>Terraform can move resources around within the state file, which means you can refactor terraform without being forced to recreate the resources. For example, this is useful for converting individual resources or a <code>count</code> resource to a <code>for_each</code> resource.</p><p>The <code>terraform state mv</code> command modifies the state and must be executed by an AWS Account Admin.</p><ol><li>(Developer) Refactor your Terraform in a new branch. On your local machine, login with the <code>aws-adfs</code> utility and verify <code>terraform plan</code> will refactor the resources as desired but would destroy/recreate the resources. Don&#39;t merge and deploy/<code>apply</code> the changes yet.</li><li>(Admin) Locally checkout the branch with the refactored terraform. Locally login to AWS account with <code>aws-adfs</code>, with admin rights.</li><li>(Admin) Locally, in the <code>iac/{env}</code> directory corresponding to the state file, run <code>terraform init</code>.</li><li>(Admin) Then, for each individual resource to refactor/move within the state, run a <code>terraform state mv</code> command with the source/destination in the state file. e.g.</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Example</span>
terraform state <span class="token function">mv</span> <span class="token string">&#39;module.example.aws_s3_bucket.an_individual_bucket&#39;</span> <span class="token string">&#39;module.example.aws_s3_bucket.fc_bucket[&quot;a-foreach-bucket&quot;]&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Look at the destroy/create for each resource in the <code>terraform plan</code> output to get the correct source and destination for each resource&#39;s mv command.</p></div><ol start="5"><li>(Developer) Once all of the moves within the state file are complete, locally verify that <code>terraform plan</code> no longer shows the recreation of all of those resources (because the state file now matches the refactored IaC).</li><li>(Developer) Merge the IaC code change and deploy (should be no changes).</li></ol>`,7),r=e(`<details class="hint-container details"><summary>Example Use Case: Refactor individual s3 bucket resources to a for_each resource</summary><h3 id="scenario" tabindex="-1"><a class="header-anchor" href="#scenario" aria-hidden="true">#</a> Scenario</h3><p>There are 18 buckets in one module, declared as individual resources with the same configuration. Terraform did not add the <code>for_each</code> feature until awhile after this IaC was created. In order to more easily maintain those s3 buckets (e.g. change the configuration without updating in 18 places) and more cleanly add outputs for the bucket data, it would be preferable to convert them from being individually declared in the IaC to a single for_each resource (which references a variable with a list of bucket names).</p><div class="language-hcl line-numbers-mode" data-ext="hcl"><pre class="language-hcl"><code><span class="token comment"># before: many individual declarations</span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;first_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;second_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;third_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-hcl line-numbers-mode" data-ext="hcl"><pre class="language-hcl"><code><span class="token comment"># after: single for_each declaration </span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;all_example_buckets&quot;</span> <span class="token punctuation">{</span>
    <span class="token property">for_each</span> <span class="token punctuation">=</span> toset(var.example_bucket_names)

    <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>each<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span>-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">env</span><span class="token punctuation">}</span></span>&quot;</span>
    <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">&quot;private&quot;</span>

    <span class="token property">tags</span> <span class="token punctuation">=</span> local.tags
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="problem" tabindex="-1"><a class="header-anchor" href="#problem" aria-hidden="true">#</a> Problem</h3><p>Moving individual resources (s3 buckets) to a for_each resource will destroy and recreate them all on <code>terraform apply</code> because they have to be referenced differently in the state file as a for-each.</p><p>If the s3 buckets are already live and contain objects you don&#39;t want to lose, recreating all of the buckets is problematic.</p><h3 id="solution" tabindex="-1"><a class="header-anchor" href="#solution" aria-hidden="true">#</a> Solution</h3><p>Use <code>terraform state mv</code> to change each bucket&#39;s reference in the state file to a for-each, in order to refactor without recreating.</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Example</span>
terraform state <span class="token function">mv</span> <span class="token string">&#39;module.example.aws_s3_bucket.first_example_bucket&#39;</span> <span class="token string">&#39;module.example.aws_s3_bucket.all_example_buckets[&quot;first-example-bucket&quot;]&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></details>`,1);function i(l,d){return s(),n("div",null,[c,t(" the Details block does not work in IE "),r])}const p=a(o,[["render",i],["__file","tf-move.html.vue"]]);export{p as default};
