import{_ as r,M as t,p as l,q as c,R as e,t as n,N as s,V as p,a1 as o}from"./framework-bf3e1922.js";const d={},u=e("h1",{id:"terraform",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#terraform","aria-hidden":"true"},"#"),n(" Terraform")],-1),h=e("p",null,"Infrastructure as Code (IaC) is a way to define what resources & configuration you need to run an application. These declarations can then be stored in git. This approach eliminates the potential for human error when setting up multiple servers & configuration drift between environments.",-1),m=e("p",null,"All cloud resources in the prod & nonprod environments must be created as IaC, and account permissions will reflect this policy.",-1),v={href:"https://www.terraform.io/",target:"_blank",rel:"noopener noreferrer"},f={href:"https://www.terraform.io/docs/providers/index.html",target:"_blank",rel:"noopener noreferrer"},b={href:"https://www.terraform.io/docs/providers/aws/index.html",target:"_blank",rel:"noopener noreferrer"},g={class:"hint-container warning"},k=e("p",{class:"hint-container-title"},"Terraform Version",-1),w=e("p",null,"Prior to January 2020, we used Terraform v0.10. We are in the process of migrating to TF 0.12.",-1),y={href:"https://github.com/tfutils/tfenv",target:"_blank",rel:"noopener noreferrer"},_=e("code",null,"tfenv",-1),q=o(`<h2 id="concepts" tabindex="-1"><a class="header-anchor" href="#concepts" aria-hidden="true">#</a> Concepts</h2><p>A simple terraform module is made up of three parts: provider blocks, a backend, and the infrastructure resources you want.</p><div class="language-hcl line-numbers-mode" data-ext="hcl"><pre class="language-hcl"><code><span class="token comment"># Provider Block</span>
<span class="token comment"># --------------</span>

<span class="token comment"># Declares that we need the AWS provider and sets a default region.</span>
<span class="token comment"># The version argument tells TF that it should use any stable v2.27.x provider.</span>
<span class="token keyword">provider<span class="token type variable"> &quot;aws&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">&quot;us-east-2&quot;</span>
  <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;~&gt; 2.27&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment"># Backend Block</span>
<span class="token comment"># -------------</span>

<span class="token comment"># This block tells Terraform that it should remember what</span>
<span class="token comment"># resources it has created using a file in an S3 bucket.</span>
<span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> &quot;s3&quot; </span></span><span class="token punctuation">{</span>
    <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">&quot;accountName-nonprod-build-tfstate&quot;</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">&quot;accountName-shared-resources/nonprod/terraform.tfstate&quot;</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">&quot;us-east-2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Resource Blocks</span>
<span class="token comment"># ---------------</span>

<span class="token comment"># Creates a Simple Notification Service topic</span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_sns_topic&quot;</span></span> <span class="token string">&quot;opsgenie_alert_topic&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;OpsGenie-SomeTeam&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment"># Adds OpsGenie&#39;s alert API as a subscriber to that topic,</span>
<span class="token comment"># using the Amazon Resource Name (ARN) that the previous resource</span>
<span class="token comment"># output.</span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_sns_topic_subscription&quot;</span></span> <span class="token string">&quot;opsgenie_integration&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">topic_arn</span>              <span class="token punctuation">=</span> aws_sns_topic.opsgenie_alert_topic.arn<span class="token string">&quot;
  protocol               = &quot;</span>https<span class="token string">&quot;
  endpoint               = &quot;</span>https:<span class="token comment">//api.opsgenie.com/alert/SomeTeam?apiKey=MyVeryCoolSecret&quot;</span>
  <span class="token property">endpoint_auto_confirms</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Terraform will automatically determine that it needs to create the topic before it can create the subscription, since the subscription is using an <em>attribute</em> (the ARN) from the topic resource.</p>`,4),S={href:"https://www.terraform.io/docs/providers/aws/r/sns_topic.html",target:"_blank",rel:"noopener noreferrer"},x=e("code",null,"aws_sns_topic",-1),A=e("code",null,"display_name",-1),T=e("h2",{id:"developing-testing-iac",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#developing-testing-iac","aria-hidden":"true"},"#"),n(" Developing & Testing IaC")],-1),I={href:"https://marketplace.visualstudio.com/items?itemName=mauve.terraform",target:"_blank",rel:"noopener noreferrer"},N=e("p",null,[n("You may check your TF code compiles with the "),e("code",null,"terraform validate"),n(" command. You will need to "),e("code",null,"terraform init"),n(" your module beforehand. If the "),e("code",null,"init"),n(" gives you errors about the S3 bucket, that is OK: the state bucket is only needed when you are planning/deploying/destroying.")],-1),C={href:"https://github.com/venth/aws-adfs",target:"_blank",rel:"noopener noreferrer"},W={class:"hint-container tip"},P=e("p",{class:"hint-container-title"},"`aws-adfs` & Duo",-1),F=e("p",null,[n("Before using the "),e("code",null,"aws-adfs"),n(" utility, you will need to configure Duo to automatically send you push notifications.")],-1),E={href:"https://aws.northwestern.edu",target:"_blank",rel:"noopener noreferrer"},B=e("em",null,"Settings",-1),D=e("em",null,"My Settings & Devices",-1),O=e("p",null,[n("Choose "),e("em",null,"Automatically Send this Device a Duo Push"),n(" to enable this functionality.")],-1),R=o(`<p>Once installed, you can run the utility with the below arguments. Your username should be in the format <code>ads\\netid</code>.</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>aws-adfs login --adfs-host<span class="token operator">=</span>ads-fed.northwestern.edu --provider-id urn:amazon:webservices <span class="token parameter variable">--region</span> us-east-2 --no-sspi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Once logged in, the utility will prompt you to choose the AWS account to use.</p><h2 id="more-about-configuring-profiles-in-the-aws-adfs-utility" tabindex="-1"><a class="header-anchor" href="#more-about-configuring-profiles-in-the-aws-adfs-utility" aria-hidden="true">#</a> More About Configuring Profiles in the AWS-ADFS Utility</h2><p>The aws-adfs utility facilitates logging you into AWS and it places your temporary credential information in your .aws/credentials files where many other applications (including terraform) know where to look and how to use it. In short, it logs into an AWS account on your behalf during the upload.</p><p>A default profile is established based on the first AWS account you use without specifically designating a profile name. Note that you can always delete your default via the reset command and establish another one. (See below.)</p><p>In addition to a default profile, you can create a profile for each AWS account that you use.</p><p>There are three commands that you will need in order to work with profiles:</p><p><strong>1. aws-adfs list</strong></p><p>Use this to list the details of all your profiles, including the default.</p><p><strong>2. --profile {YourProfileName}</strong></p><p>This is added to the standard utility statement both to create a profile and to use that profile after it is created. Once you have entered the standard utility statement with a new profile name, you will see a numbered list of all AWS account to which you have access. Enter the number of the account that you want to associate with the profile name you entered. From that point forward, that profile name is mapped to the account you selected.</p><p><em>For Example</em></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>aws-adfs login --adfs-host<span class="token operator">=</span>ads-fed.northwestern.edu --provider-id urn:amazon:webservices <span class="token parameter variable">--region</span> us-east-2 **--profile YourProfileName**
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><em>Using an existing profile</em></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> aws-adfs login <span class="token parameter variable">--profile</span> YourProfileName
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>3. aws-adfs reset --profile YourProfileName</strong></p><p>Use this to delete the named profile from the list.</p><h2 id="shortcut-configuration" tabindex="-1"><a class="header-anchor" href="#shortcut-configuration" aria-hidden="true">#</a> Shortcut Configuration</h2><p>The utility code listed above can become tedious. To shorten the process, use follow the instructions below to install a function within your bash profile that clears the current profile and sets your newly entered profile.</p><ol><li>Open bash editor: vi ~/.bash_profile</li><li>Enter i to insert</li><li>Paste in the following code:</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token keyword">function</span> <span class="token function-name function">aws-adfs-login</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>                                                                                     
	<span class="token builtin class-name">unset</span> AWS_PROFILE
	aws-adfs login --adfs-host<span class="token operator">=</span>ads-fed.northwestern.edu --provider-id urn:amazon:webservices <span class="token parameter variable">--profile</span> <span class="token variable">$1</span> --no-sspi
	<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_PROFILE</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>Enter [esc] to exit insert mode</li><li>Enter [shift]zz to save and close</li><li>If you are using linux, enter: <strong>source ~/.bash_profile</strong></li><li>To use a profile, enter the function and profile name: <strong>aws-adfs-login [YourProfileName]</strong></li><li>To see all your profiles, enter: <strong>aws-adfs list</strong></li></ol>`,23);function Y(V,z){const a=t("ExternalLinkIcon"),i=t("RouterLink");return l(),c("div",null,[u,h,m,e("p",null,[e("a",v,[n("Terraform"),s(a)]),n(" is the vendor-agnostic IaC tool that Administrative Systems uses. When you write your IaC, terraform will determine which service providers you need and will automatically download the appropriate "),e("a",f,[n("provider drivers"),s(a)]),n(".")]),e("p",null,[n("For the most part, AS developers will only need to be concerned with the "),e("a",b,[n("AWS provider"),s(a)]),n(". But if the need arises, you can use terraform to build infrastructure for one app across several cloud vendors.")]),e("div",g,[k,w,e("p",null,[n("All new IaC development should be done using TF 0.12. We recommend installing "),e("a",y,[_,s(a)]),n(" to manage your TF versions.")]),e("p",null,[n("You should upgrade your older modules to v0.12 -- see the AS "),s(i,{to:"/iac/tf-upgrading.html"},{default:p(()=>[n("upgrade guide")]),_:1}),n(" for guidance.")])]),q,e("p",null,[n("Every resource is different. The terraform AWS provider documentation will explain what arguments (inputs) & attributes (outputs) are available. For example, the "),e("a",S,[x,s(a)]),n(" documentation tells us that we could set a "),A,n(" argument too.")]),T,e("p",null,[n("Before you begin, you should install the "),e("a",I,[n("terraform extension for VS Code"),s(a)]),n(". This will give you a code formatter, syntax highlighting, tab completion, and quick navigation.")]),N,e("p",null,[n("Infrastructure in the nonprod & prod accounts may only be created by terraform running on your Jenkins server -- your own AWS login will not be able to create anything. If you wish to test terraform from your own machine, you can log in to the sandbox with the "),e("a",C,[n("aws-adfs"),s(a)]),n(" utility.")]),e("div",W,[P,F,e("p",null,[n("When logging in to "),e("a",E,[n("aws.northwestern.edu"),s(a)]),n(", hit the "),B,n(" tab on your Duo popup, then "),D,n(".")]),O]),R])}const M=r(d,[["render",Y],["__file","terraform-concepts.html.vue"]]);export{M as default};
