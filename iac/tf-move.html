<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Terraform State Move | AS Cloud Docs</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link href="https://common.northwestern.edu/v8/icons/favicon-16.png" rel="icon" sizes="16x16" type="image/png">
    <link href="https://common.northwestern.edu/v8/icons/favicon-32.png" rel="icon" sizes="32x32" type="image/png">
    <meta name="description" content="Docs for Northwestern IT staff on our cloud implementation.">
    <link rel="preload" href="/AS-CloudDocs/assets/css/0.styles.66b7ce55.css" as="style"><link rel="preload" href="/AS-CloudDocs/assets/js/app.ae460c7c.js" as="script"><link rel="preload" href="/AS-CloudDocs/assets/js/2.868eda97.js" as="script"><link rel="preload" href="/AS-CloudDocs/assets/js/28.055ebb0b.js" as="script"><link rel="prefetch" href="/AS-CloudDocs/assets/js/10.9c3425ea.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/11.ac0cecc6.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/12.6bd0e6ba.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/13.9ca59192.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/14.e57694b1.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/15.89cc6230.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/16.e55c84ba.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/17.4c7d7f3a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/18.7afbb7e8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/19.c0166409.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/20.3d997d9c.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/21.9c8b6104.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/22.6436862a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/23.4fc19cec.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/24.7df3799d.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/25.61a7df8a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/26.7558c1a5.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/27.63bd6ea2.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/29.a5382a9b.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/3.f29b8e39.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/30.f9ce488b.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/31.26a400c3.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/32.c770c34a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/33.8f326431.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/34.84ff26a4.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/35.75b0d681.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/36.1e82fcff.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/37.1b4b47bf.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/38.431607e7.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/39.70913066.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/4.0eba8a6a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/40.343909fa.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/41.dc1656de.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/42.5d3404e4.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/43.c442575a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/44.e29015d5.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/5.7da5a2df.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/6.1247cfd9.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/7.756be9c0.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/8.82adb3b5.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/9.40a788ea.js">
    <link rel="stylesheet" href="/AS-CloudDocs/assets/css/0.styles.66b7ce55.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AS-CloudDocs/" class="home-link router-link-active"><!----> <span class="site-name">AS Cloud Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Introduction</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/" aria-current="page" class="sidebar-link">Overview</a></li><li><a href="/AS-CloudDocs/roles-responsibilities.html" class="sidebar-link">Roles &amp; Responsibilities</a></li><li><a href="/AS-CloudDocs/design-for-cloud.html" class="sidebar-link">Designing Apps for the Cloud</a></li><li><a href="/AS-CloudDocs/tools.html" class="sidebar-link">Tool Recommendations</a></li><li><a href="/AS-CloudDocs/docs-site.html" class="sidebar-link">Documentation Site</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/infrastructure/aws-account-design.html" class="sidebar-link">AWS Account Structure</a></li><li><a href="/AS-CloudDocs/infrastructure/tagging.html" class="sidebar-link">Tagging Resources</a></li><li><a href="/AS-CloudDocs/infrastructure/vpc-ip-addr.html" class="sidebar-link">VPCs &amp; IP Addressing</a></li><li><a href="/AS-CloudDocs/infrastructure/alb.html" class="sidebar-link">Application Load Balancers</a></li><li><a href="/AS-CloudDocs/infrastructure/certificates.html" class="sidebar-link">Certificates</a></li><li><a href="/AS-CloudDocs/infrastructure/api-gateway.html" class="sidebar-link">API Gateway</a></li><li><a href="/AS-CloudDocs/infrastructure/lambda.html" class="sidebar-link">Lambda</a></li><li><a href="/AS-CloudDocs/infrastructure/ecs-fargate.html" class="sidebar-link">Fargate for ECS</a></li><li><a href="/AS-CloudDocs/infrastructure/ses.html" class="sidebar-link">Simple Email Service (SES)</a></li><li><a href="/AS-CloudDocs/infrastructure/iam.html" class="sidebar-link">Identity &amp; Access Management (IAM)</a></li><li><a href="/AS-CloudDocs/infrastructure/databases.html" class="sidebar-link">Databases</a></li><li><a href="/AS-CloudDocs/infrastructure/secrets.html" class="sidebar-link">Secret Management</a></li><li><a href="/AS-CloudDocs/infrastructure/alerts.html" class="sidebar-link">Alerts</a></li><li><a href="/AS-CloudDocs/infrastructure/cloudfront.html" class="sidebar-link">CloudFront CDN</a></li><li><a href="/AS-CloudDocs/infrastructure/vapor.html" class="sidebar-link">Laravel Vapor</a></li><li><a href="/AS-CloudDocs/infrastructure/aws-service-scheduler.html" class="sidebar-link">AWS Service Scheduler</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Infrastructure as Code</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/iac/terraform-concepts.html" class="sidebar-link">Terraform</a></li><li><a href="/AS-CloudDocs/iac/as-tf-modules.html" class="sidebar-link">AS Terraform Modules</a></li><li><a href="/AS-CloudDocs/iac/example-tf.html" class="sidebar-link">Example Terraform Module</a></li><li><a href="/AS-CloudDocs/iac/available-modules.html" class="sidebar-link">Available Modules</a></li><li><a href="/AS-CloudDocs/iac/state-buckets.html" class="sidebar-link">State Bucket Reference</a></li><li><a href="/AS-CloudDocs/iac/tf-import.html" class="sidebar-link">Terraform Import</a></li><li><a href="/AS-CloudDocs/iac/tf-move.html" aria-current="page" class="active sidebar-link">Terraform State Move</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/AS-CloudDocs/iac/tf-upgrading.html" class="sidebar-link">Upgrading Terraform</a></li><li><a href="/AS-CloudDocs/iac/faq.html" class="sidebar-link">Frequently Asked Questions</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CI &amp; CD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/ci-cd/jenkins.html" class="sidebar-link">Jenkins Pipelines</a></li><li><a href="/AS-CloudDocs/ci-cd/shared-libs.html" class="sidebar-link">Shared Library</a></li><li><a href="/AS-CloudDocs/ci-cd/jenkins-ecs-agent.html" class="sidebar-link">Jenkins ECS Agent</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Application Development</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/development/principles.html" class="sidebar-link">Design Principles</a></li><li><a href="/AS-CloudDocs/development/app-patterns.html" class="sidebar-link">Application Patterns</a></li><li><a href="/AS-CloudDocs/development/libraries.html" class="sidebar-link">Packages &amp; Libraries</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>GitHub</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/github/settings-permissions.html" class="sidebar-link">Settings &amp; Permissions</a></li><li><a href="/AS-CloudDocs/github/repo-layout.html" class="sidebar-link">Repository Structure</a></li><li><a href="/AS-CloudDocs/github/workflow.html" class="sidebar-link">Workflow</a></li><li><a href="/AS-CloudDocs/github/policies.html" class="sidebar-link">Policy</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="terraform-state-move"><a href="#terraform-state-move" class="header-anchor">#</a> Terraform State Move</h1> <p>Terraform can move resources around within the state file, which means you can refactor terraform without being forced to recreate the resources. For example, this is useful for converting individual resources or a <code>count</code> resource to a <code>for_each</code> resource.</p> <p>The <code>terraform state mv</code> command modifies the state and must be executed by an AWS Account Admin.</p> <ol><li>(Developer) Refactor your Terraform in a new branch. On your local machine, login with the <code>aws-adfs</code> utility and verify <code>terraform plan</code> will refactor the resources as desired but would destroy/recreate the resources. Don't merge and deploy/<code>apply</code> the changes yet.</li> <li>(Admin) Locally checkout the branch with the refactored terraform. Locally login to AWS account with <code>aws-adfs</code>, with admin rights.</li> <li>(Admin) Locally, in the <code>iac/{env}</code> directory corresponding to the state file, run <code>terraform init</code>.</li> <li>(Admin) Then, for each individual resource to refactor/move within the state, run a <code>terraform state mv</code> command with the source/destination in the state file.
e.g.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Example</span>
terraform state <span class="token function">mv</span> <span class="token string">'module.example.aws_s3_bucket.an_individual_bucket'</span> <span class="token string">'module.example.aws_s3_bucket.fc_bucket[&quot;a-foreach-bucket&quot;]'</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Look at the destroy/create for each resource in the <code>terraform plan</code> output to get the correct source and destination for each resource's mv command.</p></div> <ol start="5"><li>(Developer) Once all of the moves within the state file are complete, locally verify that <code>terraform plan</code> no longer shows the recreation of all of those resources (because the state file now matches the refactored IaC).</li> <li>(Developer) Merge the IaC code change and deploy (should be no changes).</li></ol> <details class="custom-block details"><summary>Example Use Case: Refactor individual s3 bucket resources to a for_each resource</summary> <h3 id="scenario"><a href="#scenario" class="header-anchor">#</a> Scenario</h3> <p>There are 18 buckets in one module, declared as individual resources with the same configuration. Terraform did not add the <code>for_each</code> feature until awhile after this IaC was created. In order to more easily maintain those s3 buckets (e.g. change the configuration without updating in 18 places) and more cleanly add outputs for the bucket data, it would be preferable to convert them from being individually declared in the IaC to a single for_each resource (which references a variable with a list of bucket names).</p> <div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token comment"># before: many individual declarations</span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;first_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;second_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;third_example_bucket&quot;</span> <span class="token punctuation">{</span>
    ... 
<span class="token punctuation">}</span>
</code></pre></div><div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token comment"># after: single for_each declaration </span>
<span class="token keyword">resource <span class="token type variable">&quot;aws_s3_bucket&quot;</span></span> <span class="token string">&quot;all_example_buckets&quot;</span> <span class="token punctuation">{</span>
    <span class="token property">for_each</span> <span class="token punctuation">=</span> toset(var.example_bucket_names)

    <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>each<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span>-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">env</span><span class="token punctuation">}</span></span>&quot;</span>
    <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">&quot;private&quot;</span>

    <span class="token property">tags</span> <span class="token punctuation">=</span> local.tags
<span class="token punctuation">}</span>
</code></pre></div><h3 id="problem"><a href="#problem" class="header-anchor">#</a> Problem</h3> <p>Moving individual resources (s3 buckets) to a for_each resource will destroy and recreate them all on <code>terraform apply</code> because they have to be referenced differently in the state file as a for-each.</p> <p>If the s3 buckets are already live and contain objects you don't want to lose, recreating all of the buckets is problematic.</p> <h3 id="solution"><a href="#solution" class="header-anchor">#</a> Solution</h3> <p>Use <code>terraform state mv</code> to change each bucket's reference in the state file to a for-each, in order to refactor without recreating.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Example</span>
terraform state <span class="token function">mv</span> <span class="token string">'module.example.aws_s3_bucket.first_example_bucket'</span> <span class="token string">'module.example.aws_s3_bucket.all_example_buckets[&quot;first-example-bucket&quot;]'</span>
</code></pre></div></details></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs/edit/stable/iac/tf-move.md" target="_blank" rel="noopener noreferrer">Edit Page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/12/2020, 4:17:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/AS-CloudDocs/iac/tf-import.html" class="prev">
        Terraform Import
      </a></span> <span class="next"><a href="/AS-CloudDocs/iac/tf-upgrading.html">
        Upgrading Terraform
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/AS-CloudDocs/assets/js/app.ae460c7c.js" defer></script><script src="/AS-CloudDocs/assets/js/2.868eda97.js" defer></script><script src="/AS-CloudDocs/assets/js/28.055ebb0b.js" defer></script>
  </body>
</html>
