<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Upgrading Terraform | AS Cloud Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link href="https://common.northwestern.edu/v8/icons/favicon-16.png" rel="icon" sizes="16x16" type="image/png">
    <link href="https://common.northwestern.edu/v8/icons/favicon-32.png" rel="icon" sizes="32x32" type="image/png">
    <meta name="description" content="Docs for Northwestern IT staff on our cloud implementation.">
    
    <link rel="preload" href="/AS-CloudDocs/assets/css/0.styles.425dfd68.css" as="style"><link rel="preload" href="/AS-CloudDocs/assets/js/app.bd7758c1.js" as="script"><link rel="preload" href="/AS-CloudDocs/assets/js/2.ff94c51f.js" as="script"><link rel="preload" href="/AS-CloudDocs/assets/js/35.bfd4a2a0.js" as="script"><link rel="prefetch" href="/AS-CloudDocs/assets/js/10.53b10353.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/11.30bf3f27.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/12.79b15561.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/13.0fa5fac8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/14.c790e2d3.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/15.e46eec99.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/16.ac96f9b6.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/17.dd30171a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/18.9efddfc8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/19.42954703.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/20.94487fbf.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/21.c16e1282.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/22.97eb51d7.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/23.fdc6e37e.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/24.503ed3ba.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/25.981cecb9.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/26.bfd5357b.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/27.c3671dd8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/28.d3fc2301.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/29.fc446122.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/3.21e484c9.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/30.ffbdbea1.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/31.ce405e28.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/32.44e0f1a2.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/33.3c1f4287.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/34.81f0a034.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/36.64d9b7ab.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/37.b31cf584.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/38.dca1db31.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/39.965c08d4.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/4.ecf3366a.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/40.b204b1ef.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/41.b7820605.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/42.bc43f9c4.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/43.f1aeb4e2.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/44.65ba512e.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/45.61123309.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/46.cefa0ab5.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/47.66ca5d4b.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/48.95c5b0f8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/49.c4bb334d.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/5.01c67336.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/50.1f409d90.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/6.9dbf8cb2.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/7.e43f68c8.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/8.16ee638f.js"><link rel="prefetch" href="/AS-CloudDocs/assets/js/9.d62c08d3.js">
    <link rel="stylesheet" href="/AS-CloudDocs/assets/css/0.styles.425dfd68.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AS-CloudDocs/" class="home-link router-link-active"><!----> <span class="site-name">AS Cloud Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Introduction</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/" aria-current="page" class="sidebar-link">Overview</a></li><li><a href="/AS-CloudDocs/roles-responsibilities.html" class="sidebar-link">Roles &amp; Responsibilities</a></li><li><a href="/AS-CloudDocs/design-for-cloud.html" class="sidebar-link">Designing Apps for the Cloud</a></li><li><a href="/AS-CloudDocs/tools.html" class="sidebar-link">Tool Recommendations</a></li><li><a href="/AS-CloudDocs/docs-site.html" class="sidebar-link">Documentation Site</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/infrastructure/aws-account-design.html" class="sidebar-link">AWS Account Structure</a></li><li><a href="/AS-CloudDocs/infrastructure/tagging.html" class="sidebar-link">Tagging Resources</a></li><li><a href="/AS-CloudDocs/infrastructure/vpc-ip-addr.html" class="sidebar-link">VPCs &amp; IP Addressing</a></li><li><a href="/AS-CloudDocs/infrastructure/alb.html" class="sidebar-link">Application Load Balancers</a></li><li><a href="/AS-CloudDocs/infrastructure/certificates.html" class="sidebar-link">Certificates</a></li><li><a href="/AS-CloudDocs/infrastructure/api-gateway.html" class="sidebar-link">API Gateway</a></li><li><a href="/AS-CloudDocs/infrastructure/lambda.html" class="sidebar-link">Lambda</a></li><li><a href="/AS-CloudDocs/infrastructure/ecs-fargate.html" class="sidebar-link">Fargate for ECS</a></li><li><a href="/AS-CloudDocs/infrastructure/ses.html" class="sidebar-link">Simple Email Service (SES)</a></li><li><a href="/AS-CloudDocs/infrastructure/iam.html" class="sidebar-link">Identity &amp; Access Management (IAM)</a></li><li><a href="/AS-CloudDocs/infrastructure/databases.html" class="sidebar-link">Databases</a></li><li><a href="/AS-CloudDocs/infrastructure/secrets.html" class="sidebar-link">Secret Management</a></li><li><a href="/AS-CloudDocs/infrastructure/alerts.html" class="sidebar-link">Alerts</a></li><li><a href="/AS-CloudDocs/infrastructure/cloudfront.html" class="sidebar-link">CloudFront CDN</a></li><li><a href="/AS-CloudDocs/infrastructure/vapor.html" class="sidebar-link">Laravel Vapor</a></li><li><a href="/AS-CloudDocs/infrastructure/aws-service-scheduler.html" class="sidebar-link">AWS Service Scheduler</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Infrastructure as Code</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/iac/terraform-concepts.html" class="sidebar-link">Terraform</a></li><li><a href="/AS-CloudDocs/iac/as-tf-modules.html" class="sidebar-link">AS Terraform Modules</a></li><li><a href="/AS-CloudDocs/iac/example-tf.html" class="sidebar-link">Example Terraform Module</a></li><li><a href="/AS-CloudDocs/iac/available-modules.html" class="sidebar-link">Available Modules</a></li><li><a href="/AS-CloudDocs/iac/state-buckets.html" class="sidebar-link">State Bucket Reference</a></li><li><a href="/AS-CloudDocs/iac/tf-import.html" class="sidebar-link">Terraform Import</a></li><li><a href="/AS-CloudDocs/iac/tf-move.html" class="sidebar-link">Terraform State Move</a></li><li><a href="/AS-CloudDocs/iac/tf-upgrading.html" aria-current="page" class="active sidebar-link">Upgrading Terraform</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/AS-CloudDocs/iac/tf-upgrading.html#strategy" class="sidebar-link">Strategy</a></li><li class="sidebar-sub-header"><a href="/AS-CloudDocs/iac/tf-upgrading.html#upgrading-from-v0-10" class="sidebar-link">Upgrading from v0.10</a></li><li class="sidebar-sub-header"><a href="/AS-CloudDocs/iac/tf-upgrading.html#going-live-with-the-upgrade" class="sidebar-link">Going Live with the Upgrade</a></li><li class="sidebar-sub-header"><a href="/AS-CloudDocs/iac/tf-upgrading.html#vs-code-support" class="sidebar-link">VS Code Support</a></li></ul></li><li><a href="/AS-CloudDocs/iac/faq.html" class="sidebar-link">Frequently Asked Questions</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CI &amp; CD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/ci-cd/jenkins.html" class="sidebar-link">Jenkins Pipelines</a></li><li><a href="/AS-CloudDocs/ci-cd/shared-libs.html" class="sidebar-link">Shared Library</a></li><li><a href="/AS-CloudDocs/ci-cd/jenkins-ecs-agent.html" class="sidebar-link">Jenkins ECS Agent</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Application Development</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/development/principles.html" class="sidebar-link">Design Principles</a></li><li><a href="/AS-CloudDocs/development/app-patterns.html" class="sidebar-link">Application Patterns</a></li><li><a href="/AS-CloudDocs/development/laravel-stack.html" class="sidebar-link">Laravel Stack</a></li><li><a href="/AS-CloudDocs/development/express-stack.html" class="sidebar-link">ExpressJS Stack</a></li><li><a href="/AS-CloudDocs/development/spring-stack.html" class="sidebar-link">Spring Stack</a></li><li><a href="/AS-CloudDocs/development/frontend-stacks.html" class="sidebar-link">Frontend Stacks</a></li><li><a href="/AS-CloudDocs/development/libraries.html" class="sidebar-link">Packages &amp; Libraries</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>GitHub</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AS-CloudDocs/github/settings-permissions.html" class="sidebar-link">Settings &amp; Permissions</a></li><li><a href="/AS-CloudDocs/github/repo-layout.html" class="sidebar-link">Repository Structure</a></li><li><a href="/AS-CloudDocs/github/workflow.html" class="sidebar-link">Workflow</a></li><li><a href="/AS-CloudDocs/github/policies.html" class="sidebar-link">Policy</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="upgrading-terraform"><a href="#upgrading-terraform" class="header-anchor">#</a> Upgrading Terraform</h1> <p>Prior to January 2020, all IaC was written in Terraform v0.10.x. One selected version of the <code>terraform</code> command was available on the Jenkins servers.</p> <p>The v0.10 series has reached the end of its useful life: the AWS provider will <a href="https://www.hashicorp.com/blog/deprecating-terraform-0-11-support-in-terraform-providers/" target="_blank" rel="noopener noreferrer">no longer be updated<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for Terraform 0.11 and older. Without active support on the AWS provider, new AWS features will be unavailable to us. As time goes on, AWS API changes may leave existing IaC modules broken &amp; unable to build.</p> <h2 id="strategy"><a href="#strategy" class="header-anchor">#</a> Strategy</h2> <p>A utility called <a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer"><code>tfenv</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is available on the Jenkins servers. This is similar to Python's <code>virtual_env</code>, Node's <code>nvm</code>, or Ruby's <code>rbenv</code>. It allows you to select a specific version of Terraform on a per-project basis.</p> <p>This utility will allow us to run multiple versions of Terraform on the same Jenkins server. Projects may be upgraded one-by-one, instead of needing all jobs on one Jenkins server to upgrade to Terraform v0.12 in unison.</p> <h2 id="upgrading-from-v0-10"><a href="#upgrading-from-v0-10" class="header-anchor">#</a> Upgrading from v0.10</h2> <p>The Terraform language has undergone significant changes in v0.12. It has a tool to convert your terraform files, but there are some items that cannot be automatically updated.</p> <p>You should carefully review <a href="https://www.terraform.io/upgrade-guides/0-12.html" target="_blank" rel="noopener noreferrer">the official upgrade guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and identify any features you are using that may require your attention before you undertake an upgrade.</p> <ol><li><p>Install the <code>tfenv</code> command on your workstation</p> <p>You should remove any versions of Terraform that you had installed previously; they can be re-installed under <code>tfenv</code>'s management</p></li> <li><p>Create a new git branch for the upgrade</p></li> <li><p>Create a <code>.terraform-version</code> file in the root of your project. This file is used by <code>tfenv</code> to determine what version to install</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">cat</span> .terraform-version
latest:0.12
</code></pre></div></li> <li><p>Install terraform by running <code>tfenv install</code> in the root of your project</p></li> <li><p>Run the automatic upgrade command for each folder containing <code>.tf</code> files.</p> <p>The <a href="/AS-CloudDocs/iac/as-tf-modules.html">recommended module structure</a> dictates that all env-specific modules use the same 'base' code. This means all the env-specific modules must be upgraded alongside it. You cannot piecemeal this step.</p> <p>The upgrade tool considers these on a folder-by-folder basis. It will not follow references to other folders or remote modules.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># This is an example -- your base module &amp; envs may differ.</span>
<span class="token comment"># If you have any .tf files in the project root, make sure to do</span>
<span class="token comment"># that folder as well.</span>
$ terraform <span class="token number">0</span>.12upgrade -yes sandbox/
$ terraform <span class="token number">0</span>.12upgrade -yes nonprod/
$ terraform <span class="token number">0</span>.12upgrade -yes prod/

<span class="token comment"># Any modules that use providers will need those providers installed</span>
<span class="token comment"># before they can be upgraded.</span>
$ terraform init base/
$ terraform <span class="token number">0</span>.12upgrade -yes base/
$ <span class="token function">rm</span> -rf base/.terraform
</code></pre></div></li> <li><p>Adjust your <code>.terraform-version</code> file again. The upgrade may have written a specific patch version, but we want on-the-fly updates for the patch version.</p> <p>It should be:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">cat</span> .terraform-version
latest:0.12
</code></pre></div></li> <li><p>Remove any <code>versions.tf</code> files in your environment-specific folders.</p> <p>This file tells Terraform the minimum version number the module may run on. The upgrade command will emit these for each folder it is run in.</p> <p>In the interest of DRY code, we only want this file in the base module that all of the env-specific modules use. They will all inherently rely on its version specification.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># From the project root:</span>
$ <span class="token function">find</span> <span class="token builtin class-name">.</span> -name versions.tf
./prod/versions.tf
./nonprod/versions.tf
./sandbox/versions.tf
./base/versions.tf

<span class="token comment"># Leave the one in base, but remove all others:</span>
$ <span class="token function">rm</span> ./prod/versions.tf ./nonprod/versions.tf ./sandbox/versions.tf
</code></pre></div></li> <li><p>If you have pinned the AWS provider version for your module, review this and decide if it is appropriate to update the version.</p> <p>This was done for some IaC modules. The older provider uses older AWS APIs, allowing the module to build without making changes that Amazon needs for the newer APIs.</p> <p>This is a good opportunity to review and upgrade to the latest provider.</p> <p>If you have pinned the provider version, it will look like this:</p> <div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token keyword">provider<span class="token type variable"> &quot;aws&quot; </span></span><span class="token punctuation">{</span>
    <span class="token comment"># Pinned to 1.33 and older</span>
    <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&lt;= 1.13.0&quot;</span>

    <span class="token comment"># Pinned to 1.60.x</span>
    <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;~&gt; 1.60&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You should at least migrate to the 2.x provider. The latest version can be found on the <a href="https://registry.terraform.io/providers/hashicorp/aws" target="_blank" rel="noopener noreferrer">Terraform registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. If you move to the latest evrsion, you can set up Dependabot for the repository and receive pull requests when new versions of the provider are available.</p></li> <li><p>If you are using any of the <a href="/AS-CloudDocs/iac/available-modules.html">AS shared modules</a>, you will need to use their <code>tf-0.12</code> branch. All you need to do is add/update <code>?ref=&lt;branch name&gt;</code> in the git URLs.</p> <div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token keyword">module<span class="token type variable"> &quot;alb&quot; </span></span><span class="token punctuation">{</span>
    <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">&quot;github.com/NIT-Administrative-Systems/AS-Common-AWS-Modules//alb?ref=tf-0.12&quot;</span>

    <span class="token comment">// . . .</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Run the validator tool for each module and review your Terraform code.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token builtin class-name">cd</span> nonprod
$ terraform init <span class="token comment"># errors about the state file are expected and OK</span>
$ terraform validate
$ <span class="token function">rm</span> -rf .terraform
</code></pre></div><p>Fix any errors raised by the upgrade tool &amp; any other issues you identify.</p> <p>Warnings will be called out when you run the upgrade command, but they will be annotated in the code as well. Look for <code>TF-UPGRADE-TODO</code> comments.</p></li> <li><p>Log in to AWS from your console and review the plan</p> <p>You can use the <a href="/AS-CloudDocs/iac/terraform-concepts.html#developing-testing-iac">aws-adfs tool</a> to log in to AWS on your console. Select the correct account (e.g. planning dev = nonprod AWS account) when logging in.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token builtin class-name">cd</span> nonprod/
$ terraform init
$ terraform plan
$ <span class="token function">rm</span> -rf .terraform
</code></pre></div><p>In most cases, the plan will show no changes. There may be exceptions to this. You can review older deployments to determine if that was normal in v0.10; if it was, the v0.10 and v0.12 plans should reflect that the same resources need to change. The exceptions we know about are:</p> <ul><li>API Gateway deployments may show up if a run will always re-deploy the API Gateway</li> <li>Lambdas may show up if the code or dependencies have changed, since the last modified date, source code hash, and/or etag (for the zip containing the code) have changed</li></ul> <p>You may not be able to generate a complete plan. If you are using encrypted SSM parameters with a custom KMS key, you will not have enough access to decrypt the values, which Terraform wants to consider for its plan.</p></li> <li><p>Update your Jenkins pipeline files to use <code>tfenv</code> and auto-approve the plan</p> <p>You will need a new stage before <code>terraform</code> is used to grab the correct version for your project. In the context of your <code>stages</code> block, prepend:</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>stage <span class="token punctuation">(</span><span class="token string">'tfenv'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    steps <span class="token punctuation">{</span>
        sh <span class="token string">'tfenv install'</span>
        sh <span class="token string">'terraform -version'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You will also need to add the <code>-auto-approve</code> flag to <code>terraform apply</code>:</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>stage <span class="token punctuation">(</span><span class="token string">'Existing Apply Stage'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    steps <span class="token punctuation">{</span>
        sh <span class="token string">'terraform apply -auto-approve -no-color'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="going-live-with-the-upgrade"><a href="#going-live-with-the-upgrade" class="header-anchor">#</a> Going Live with the Upgrade</h2> <p>Once your v0.12 changes are valid, moving the new module into production should be painless. The underlying terraform code may have been updated, but the <code>terraform plan</code> should be unchanged. No changes should be made to your infrastructure as a result of this upgrade.</p> <p>After you run <code>terraform apply</code> with the new version of terraform, that module's <code>tfstate</code> is updated. This occurs even if the <code>terraform apply</code> command fails to fully execute. You cannot revert to a older version of terraform. This is applicable even for minor version bumps (e.g. 0.12.19 to 0.12.20).</p> <h2 id="vs-code-support"><a href="#vs-code-support" class="header-anchor">#</a> VS Code Support</h2> <p>If you are using the Terraform VS Code extension, you will need to make adjustments to its configuration so it will work with the v0.12 language changes.</p> <p>In your VS Code setting JSON file, set these options:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token comment">// . . .</span>
    <span class="token property">&quot;terraform.indexing.enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;terraform.languageServer.enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Restart VS Code. It should prompt you to install &amp; run the Terraform Language Server. Once complete, you should regain the full use of the extension.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NIT-Administrative-Systems/AS-CloudDocs/edit/stable/iac/tf-upgrading.md" target="_blank" rel="noopener noreferrer">Edit Page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/26/2021, 6:40:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/AS-CloudDocs/iac/tf-move.html" class="prev">
        Terraform State Move
      </a></span> <span class="next"><a href="/AS-CloudDocs/iac/faq.html">
        Frequently Asked Questions
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/AS-CloudDocs/assets/js/app.bd7758c1.js" defer></script><script src="/AS-CloudDocs/assets/js/2.ff94c51f.js" defer></script><script src="/AS-CloudDocs/assets/js/35.bfd4a2a0.js" defer></script>
  </body>
</html>
